<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Falling Bubble Multiplication</title>
  <style>
    :root {
      --bg1: #a8edea;
      --bg2: #fed6e3;
      --text: #0b2a2f;
      --correct: #4ade80;
      --wrong: #ef4444;
      --streak: #f59e0b;
      --question-hue: 200;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background: linear-gradient(to top, var(--bg1), var(--bg2));
      overflow: hidden;
      user-select: none;
    }

    /* Main Menu Styles */
    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: opacity 0.3s ease;
    }

    .menu-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* Help overlay */
    .help-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 12;
      transition: opacity 0.25s ease;
    }
    .help-overlay.hidden { opacity: 0; pointer-events: none; }
    .help-panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 20px 24px;
      max-width: 420px;
      width: 92vw;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      color: var(--text);
    }
    .help-panel h3 { margin: 0 0 6px; }
    .help-panel ul { margin: 8px 0 16px; padding-left: 18px; }
    .help-panel li { margin: 4px 0; }

    .menu-panel {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      text-align: center;
      max-width: 400px;
      width: 90%;
      transform: scale(1);
      transition: transform 0.3s ease;
    }

    .menu-overlay.hidden .menu-panel {
      transform: scale(0.9);
    }

    .menu-title {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 10px;
      background: linear-gradient(45deg, var(--correct), var(--streak));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .menu-subtitle {
      font-size: 16px;
      opacity: 0.7;
      margin-bottom: 30px;
    }

    .menu-section {
      margin-bottom: 25px;
    }

    .menu-section h3 {
      font-size: 18px;
      margin-bottom: 15px;
      color: var(--text);
    }

    .menu-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .menu-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.7);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      min-width: 80px;
    }

    .menu-btn:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .menu-btn.active {
      background: var(--correct);
      color: white;
      transform: translateY(-1px);
    }

    .start-btn {
      background: linear-gradient(45deg, var(--correct), var(--streak));
      color: white;
      font-size: 18px;
      font-weight: 700;
      padding: 15px 40px;
      border-radius: 25px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      margin-top: 20px;
    }

    .start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .stats-section {
      background: rgba(255, 255, 255, 0.5);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      text-align: center;
    }

    .stat-item {
      font-size: 14px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--streak);
    }

    .stat-label {
      opacity: 0.7;
      font-size: 12px;
    }

    /* Game UI Styles */
    .hud {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: grid;
      grid-auto-flow: column;
      gap: 16px;
      align-items: center;
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(12px);
      box-shadow: 0 10px 28px rgba(0,0,0,0.14);
      z-index: 3;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .hud.visible {
      opacity: 1;
    }

    .question {
      font-weight: 800;
      letter-spacing: 0.5px;
      font-size: clamp(18px, 3vw, 28px);
    }

    .score-primary { font-weight: 800; font-size: clamp(14px, 2.2vw, 18px); }
    .score-sub { font-weight: 600; font-size: 12px; opacity: 0.75; }

    .game-controls {
      position: absolute;
      top: 12px;
      right: 20px;
      display: flex;
      gap: 8px;
      z-index: 3;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .game-controls.visible {
      opacity: 1;
    }

    .control-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 20px;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(4px);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
    }

    .control-btn:hover {
      background: rgba(255,255,255,0.9);
      transform: translateY(-1px);
    }

    .streak-indicator {
      position: absolute;
      top: 80px;
      right: 20px;
      padding: 8px 12px;
      border-radius: 20px;
      background: linear-gradient(45deg, var(--streak), #fbbf24);
      color: white;
      font-weight: 700;
      font-size: 14px;
      transform: scale(0);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 3;
    }

    .streak-indicator.show {
      transform: scale(1);
    }

    .feedback {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 32px;
      font-weight: 800;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      opacity: 0;
      pointer-events: none;
      z-index: 4;
    }

    .feedback.show {
      animation: feedbackPop 0.6s ease-out;
    }

    @keyframes feedbackPop {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
    }

    .stage {
    position: relative;
    width: 400px;
    height: 100vh;
    overflow: hidden;
    margin: 0 auto;
    border-left: 2px solid rgba(255, 255, 255, 0.3);
    border-right: 2px solid rgba(255, 255, 255, 0.3);
    }

    .bubble {
        position: absolute;
        left: 0; top: 0;
        width: 70px; height: 70px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(173,216,230,0.7) 60%, rgba(135,206,235,0.4) 100%);
        box-shadow:
            inset -6px -6px 12px rgba(255,255,255,0.65),
            inset 8px 8px 14px rgba(0,0,0,0.08),
            0 10px 20px rgba(0,0,0,0.08);
        cursor: pointer;
        transition: transform 120ms ease;
        will-change: transform, filter, opacity;
        display: grid;
        place-items: center;
        padding: 6px;
    }
    
    .bubble:hover { transform: scale(1.05); }
    .bubble:active { transform: scale(0.95); }

    .bubble.falling {
      animation: fall linear forwards;
    }

    @keyframes fall {
      from { 
        transform: translateY(-150px) rotateZ(0deg); 
        opacity: 0;
      }
      5% {
        opacity: 1;
      }
      95% {
        opacity: 1;
      }
      to { 
        transform: translateY(calc(100vh + 150px)) rotateZ(360deg); 
        opacity: 0;
      }
    }

    .bubble.power-up {
      background: radial-gradient(circle at 30% 30%, rgba(255,215,0,0.9), rgba(255,140,0,0.7) 60%, rgba(255,69,0,0.4) 100%);
      box-shadow:
        inset -6px -6px 12px rgba(255,255,255,0.65),
        inset 8px 8px 14px rgba(255,140,0,0.15),
        0 10px 20px rgba(255,140,0,0.2),
        0 0 30px rgba(255,215,0,0.3);
      animation: fall linear forwards, powerGlow 2s ease-in-out infinite;
    }

    @keyframes powerGlow {
      0%, 100% { 
        box-shadow: 
          inset -6px -6px 12px rgba(255,255,255,0.65), 
          inset 8px 8px 14px rgba(255,140,0,0.15), 
          0 10px 20px rgba(255,140,0,0.2), 
          0 0 30px rgba(255,215,0,0.3); 
      }
      50% { 
        box-shadow: 
          inset -6px -6px 12px rgba(255,255,255,0.65), 
          inset 8px 8px 14px rgba(255,140,0,0.15), 
          0 10px 20px rgba(255,140,0,0.2), 
          0 0 50px rgba(255,215,0,0.5); 
      }
    }

    .bubble::before {
      content: "";
      position: absolute;
      left: 18%; top: 18%;
      width: 35%; height: 35%;
      background: radial-gradient(circle, rgba(255,255,255,0.95), rgba(255,255,255,0) 60%);
      border-radius: 50%;
      filter: blur(0.5px);
      pointer-events: none;
    }

    .label {
    position: relative;
    z-index: 1;
    font-weight: 800;
    font-size: 18px;
    letter-spacing: 0.5px;
    color: #114b5f;
    text-shadow: 0 1px 0 rgba(255,255,255,0.7);
    user-select: none;
    pointer-events: none;
    }

    .label.underlined {
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 2px;
    }

    .bubble.power-up .label {
      color: #8b4513;
      text-shadow: 0 1px 0 rgba(255,255,255,0.9);
    }

    .bubble.correct {
      animation: popAndFall 0.3s ease-out forwards;
      filter: saturate(1.2) brightness(1.1);
    }

    @keyframes popAndFall {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.9; filter: blur(0.2px); }
      100% { transform: scale(0.3); opacity: 0; filter: blur(0.5px); }
    }

    .bubble.wrong {
      animation: wrongShake 0.4s ease-out forwards;
      filter: hue-rotate(330deg) saturate(1.2) brightness(1.05);
      box-shadow:
        inset -4px -6px 10px rgba(255,255,255,0.5),
        inset 8px 10px 16px rgba(255,0,0,0.15),
        0 10px 22px rgba(255,0,0,0.10);
    }

    @keyframes wrongShake {
      0%, 100% { transform: translateX(0); opacity: 1; }
      20% { transform: translateX(-5px); }
      40% { transform: translateX(5px); }
      60% { transform: translateX(-3px); }
      80% { transform: translateX(3px); opacity: 0.7; }
      100% { transform: translateX(0); opacity: 0; }
    }

    .ring {
      position: absolute;
      width: 14px; height: 14px;
      margin-left: -7px; margin-top: -7px;
      border: 3px solid rgba(255,255,255,0.9);
      border-radius: 999px;
      pointer-events: none;
      animation: ripple 300ms ease-out forwards;
      box-shadow: 0 0 10px rgba(255,255,255,0.6);
      z-index: 2;
    }
    @keyframes ripple {
      from { transform: scale(0.25); opacity: 0.9; border-width: 3px; }
      to   { transform: scale(5);    opacity: 0;   border-width: 1px; }
    }

    .particle {
      position: absolute;
      width: 8px; height: 8px;
      margin-left: -4px; margin-top: -4px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), rgba(135,206,235,0.9));
      pointer-events: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      animation: shoot 380ms cubic-bezier(.15,.6,.2,1) forwards;
      z-index: 2;
    }
    @keyframes shoot {
      from { transform: translate3d(0,0,0) scale(1); opacity: 1; }
      to   { transform: translate3d(var(--dx, 0px), var(--dy, 0px), 0) scale(0.5); opacity: 0; }
    }

    .particle.streak {
      background: radial-gradient(circle at 30% 30%, rgba(255,215,0,0.95), rgba(255,140,0,0.9));
    }

    .flash {
      position: absolute; inset: 0;
      background: radial-gradient(ellipse at 50% 40%, rgba(255,255,255,0.45), rgba(255,255,255,0) 60%);
      pointer-events: none;
      animation: flash 220ms ease-out forwards;
      z-index: 1;
    }
    @keyframes flash {
      from { opacity: 0.45; }
      to   { opacity: 0; }
    }

    .answer-reveal {
      position: absolute;
      color: var(--wrong);
      font-weight: 800;
      font-size: 24px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      pointer-events: none;
      animation: revealAnswer 1.5s ease-out forwards;
      z-index: 3;
    }

    @keyframes revealAnswer {
      0% { opacity: 0; transform: translateY(0) scale(0.8); }
      30% { opacity: 1; transform: translateY(-20px) scale(1); }
      100% { opacity: 0; transform: translateY(-40px) scale(0.9); }
    }

    .lives-indicator {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 3;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .lives-indicator.visible {
      opacity: 1;
    }

    /* High score toast */
    .highscore-toast {
      position: absolute;
      top: 64px;
      left: 50%;
      transform: translateX(-50%) translateY(6px);
      background: linear-gradient(45deg, var(--correct), var(--streak));
      color: #fff;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.18);
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s, transform .25s;
      z-index: 5;
    }
    .highscore-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    .heart {
      width: 30px;
      height: 30px;
      background: var(--wrong);
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      transform: rotate(-45deg);
      position: relative;
      transition: all 0.3s ease;
    }

    .heart.lost {
      background: #ccc;
      transform: rotate(-45deg) scale(0.7);
      opacity: 0.5;
    }

    .heart::before,
    .heart::after {
      content: '';
      width: 26px;
      height: 40px;
      position: absolute;
      left: 15px;
      top: -20px;
      background: var(--wrong);
      border-radius: 25px 25px 0 0;
      transform: rotate(-45deg);
      transform-origin: 0 100%;
    }

    .heart.lost::before,
    .heart.lost::after {
      background: #ccc;
    }

    .heart::after {
      left: 0;
      transform: rotate(45deg);
      transform-origin: 100% 100%;
    }

    @media (max-width: 768px) {
    .stage {
        width: 320px;
    }
    .bubble {
        width: 60px;
        height: 60px;
    }
    .label {
        font-size: 16px;
    }
    .menu-panel {
        padding: 30px 20px;
    }
    .menu-title {
        font-size: 24px;
    }
    .menu-btn {
        font-size: 12px;
        padding: 10px 15px;
        min-width: 60px;
    }
    .heart {
        width: 25px;
        height: 25px;
    }
    }

    /* Epic explosion effects */
.explosion-particle {
  position: absolute;
  width: 12px; 
  height: 12px;
  margin-left: -6px; 
  margin-top: -6px;
  border-radius: 50%;
  pointer-events: none;
  z-index: 2;
}

.explosion-particle.fire {
  background: radial-gradient(circle, #ff6b35, #f7931e);
  box-shadow: 0 0 10px #ff6b35;
  animation: fireExplode 0.8s cubic-bezier(.25,.46,.45,.94) forwards;
}

.explosion-particle.spark {
  background: radial-gradient(circle, #ffd700, #ffff00);
  box-shadow: 0 0 8px #ffd700;
  animation: sparkExplode 0.9s cubic-bezier(.25,.46,.45,.94) forwards;
}

.explosion-particle.smoke {
  background: radial-gradient(circle, rgba(200,200,200,0.8), rgba(150,150,150,0.3));
  animation: smokeExplode 1.2s ease-out forwards;
}

@keyframes fireExplode {
  0% { 
    transform: translate3d(0,0,0) scale(0.3) rotate(0deg); 
    opacity: 1; 
  }
  30% { 
    transform: translate3d(var(--dx), var(--dy), 0) scale(1.2) rotate(180deg); 
    opacity: 0.9; 
  }
  100% { 
    transform: translate3d(calc(var(--dx) * 2), calc(var(--dy) * 2), 0) scale(0.1) rotate(360deg); 
    opacity: 0; 
  }
}

@keyframes sparkExplode {
  0% { 
    transform: translate3d(0,0,0) scale(0.5) rotate(0deg); 
    opacity: 1; 
  }
  40% { 
    transform: translate3d(var(--dx), var(--dy), 0) scale(1) rotate(270deg); 
    opacity: 1; 
  }
  100% { 
    transform: translate3d(calc(var(--dx) * 1.8), calc(var(--dy) * 1.8), 0) scale(0.2) rotate(540deg); 
    opacity: 0; 
  }
}

@keyframes smokeExplode {
  0% { 
    transform: translate3d(0,0,0) scale(0.2); 
    opacity: 0.6; 
  }
  50% { 
    transform: translate3d(calc(var(--dx) * 0.5), calc(var(--dy) * 0.5), 0) scale(2); 
    opacity: 0.3; 
  }
  100% { 
    transform: translate3d(var(--dx), var(--dy), 0) scale(3); 
    opacity: 0; 
  }
}

.shockwave {
  position: absolute;
  border: 4px solid rgba(255, 215, 0, 0.8);
  border-radius: 50%;
  pointer-events: none;
  animation: shockwaveExpand 0.6s ease-out forwards;
  z-index: 2;
}

@keyframes shockwaveExpand {
  0% { 
    width: 20px; 
    height: 20px; 
    margin-left: -10px; 
    margin-top: -10px; 
    opacity: 1; 
    border-width: 4px; 
  }
  100% { 
    width: 200px; 
    height: 200px; 
    margin-left: -100px; 
    margin-top: -100px; 
    opacity: 0; 
    border-width: 1px; 
  }
}

.screen-shake {
  animation: screenShake 0.4s ease-in-out;
}

@keyframes screenShake {
  0%, 100% { transform: translateX(0); }
  10% { transform: translateX(-3px) translateY(1px); }
  20% { transform: translateX(3px) translateY(-1px); }
  30% { transform: translateX(-2px) translateY(2px); }
  40% { transform: translateX(2px) translateY(-2px); }
  50% { transform: translateX(-1px) translateY(1px); }
  60% { transform: translateX(1px) translateY(-1px); }
  70% { transform: translateX(-2px) translateY(0px); }
  80% { transform: translateX(2px) translateY(0px); }
  90% { transform: translateX(-1px) translateY(0px); }
}

/* Special milestone animations */
.milestone-celebration {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 20;
  animation: fadeOut 1.5s ease-in forwards;
  animation-delay: 1s;
}

@keyframes fadeOut {
  0% { opacity: 1; }
  100% { opacity: 0; }
}

.milestone-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 48px;
  font-weight: 900;
  text-align: center;
  text-shadow: 0 2px 10px rgba(0,0,0,0.3);
  animation: textPulse 1.5s ease-out;
}

@keyframes textPulse {
  0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
  50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
  100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}

.confetti {
  position: absolute;
  width: 10px;
  height: 10px;
  background: var(--confetti-color, #f00);
  animation: confettiFall linear forwards;
}

@keyframes confettiFall {
  0% { 
    transform: translateY(-20px) rotate(0deg); 
    opacity: 1;
  }
  90% { 
    opacity: 1;
  }
  100% { 
    transform: translateY(100vh) rotate(360deg); 
    opacity: 0;
  }
}

.firework {
  position: absolute;
  width: 5px;
  height: 5px;
  border-radius: 50%;
  animation: fireworkExplode 0.8s ease-out forwards;
}

@keyframes fireworkExplode {
  0% { 
    transform: translate(var(--startX), var(--startY)) scale(0);
    opacity: 1;
  }
  100% { 
    transform: translate(var(--endX), var(--endY)) scale(1);
    opacity: 0;
  }
}

.star-burst {
  position: absolute;
  width: 100px;
  height: 100px;
  background: radial-gradient(circle, #ffdd00, transparent 70%);
  border-radius: 50%;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  animation: starBurst 1s ease-out forwards;
  opacity: 0;
}

@keyframes starBurst {
  0% { 
    transform: translate(-50%, -50%) scale(0);
    opacity: 1;
  }
  100% { 
    transform: translate(-50%, -50%) scale(3);
    opacity: 0;
  }
}

/* Special milestone specific styles */
.milestone-7 .milestone-text {
  color: #ff6b6b;
  background: linear-gradient(45deg, #ff6b6b, #ff8e53);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.milestone-10 .milestone-text {
  color: #4ecdc4;
  background: linear-gradient(45deg, #4ecdc4, #556270);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.milestone-15 .milestone-text {
  color: #ffd93d;
  background: linear-gradient(45deg, #ffd93d, #ff6b6b);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}
.bubble.expired {
  opacity: 0.1;              
  filter: grayscale(1) blur(1px);
  pointer-events: none;
  transition: all 0.4s ease;  
}
/* CSS */
.click-wave {
  position: absolute;
  width: 20px; height: 20px;
  margin: -10px 0 0 -10px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(255,255,255,.9) 0%, transparent 70%);
  pointer-events: none;
  animation: clickPop 300ms ease-out forwards;
  z-index: 5;
}
@keyframes clickPop {
  0%   { transform: scale(0.2); opacity: 1; }
  100% { transform: scale(3);   opacity: 0; }
}
.ghost {
  position: absolute;
  width: 70px; height: 70px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(255,255,255,.15), transparent 60%);
  box-shadow: 0 0 0 2px rgba(255,255,255,.3);
  pointer-events: none;
  animation: ghostLift 1s ease-out forwards;
  z-index: 1;
}
@keyframes ghostLift {
  0%   { transform: translateY(0); opacity: .6; }
  100% { transform: translateY(-80px); opacity: 0; }
}

.streak-bar {
  position: absolute;
  top: 108px;
  right: 20px;
  width: 120px; height: 6px;
  background: rgba(255,255,255,.4);
  border-radius: 3px;
  overflow: hidden;
  opacity: 0;
  transition: opacity .3s;
}
.streak-bar.show { opacity: 1; }
#streakFill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #fbbf24, #f59e0b);
  transition: width .25s;
}
@keyframes fall {
  from { transform: translateY(-150px) rotateZ(0deg) translateX(0); }
  25%  { transform: translateY(25vh)   rotateZ(90deg)  translateX(5px); }
  50%  { transform: translateY(50vh)   rotateZ(180deg) translateX(0); }
  75%  { transform: translateY(75vh)   rotateZ(270deg) translateX(-5px); }
  to   { transform: translateY(calc(100vh + 150px)) rotateZ(360deg) translateX(0); }
}
.recap-card {
  position: fixed;
  inset: 0;
  margin: auto;
  width: 260px; height: 180px;
  background: rgba(255,255,255,.95);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,.2);
  text-align: center;
  padding: 20px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  z-index: 25;
  transform: scale(.8);
  opacity: 0;
  transition: .4s;
}
.recap-card.show { transform: scale(1); opacity: 1; }
.recap-card button {
  margin-top: 12px;
  padding: 8px 20px;
  border: none;
  border-radius: 12px;
  background: var(--correct);
  color: #fff;
  font-weight: 700;
  cursor: pointer;
}
body {
  background: linear-gradient(to top, hsl(var(--hue), 60%, 85%), hsl(calc(var(--hue) + 30), 70%, 92%));
  transition: background 1s;
}
  </style>
</head>
<body>
  <!-- Main Menu -->
  <div class="menu-overlay" id="menuOverlay">
    <div class="menu-panel">
      <h1 class="menu-title">Bubble Math</h1>
      <p class="menu-subtitle">Catch the correct answers before they fall!</p>
      
      <div class="stats-section">
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="bestScoreStat">0</div>
            <div class="stat-label">Best Score</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="bestStreakStat">0</div>
            <div class="stat-label">Best Streak</div>
          </div>
        </div>
      </div>

      <div class="menu-section">
        <h3>Difficulty</h3>
        <div class="menu-buttons">
          <button class="menu-btn active" onclick="setMenuDifficulty('easy')" id="menuEasyBtn">Easy (2-5)</button>
          <button class="menu-btn" onclick="setMenuDifficulty('medium')" id="menuMediumBtn">Medium (2-8)</button>
          <button class="menu-btn" onclick="setMenuDifficulty('hard')" id="menuHardBtn">Hard (2-12)</button>
        </div>
      </div>

      <div class="menu-section">
        <h3>Speed</h3>
        <div class="menu-buttons">
          <button class="menu-btn" onclick="setMenuSpeed('slow')" id="menuSlowBtn">Slow</button>
          <button class="menu-btn active" onclick="setMenuSpeed('normal')" id="menuNormalBtn">Normal</button>
          <button class="menu-btn" onclick="setMenuSpeed('fast')" id="menuFastBtn">Fast</button>
          <button class="menu-btn" onclick="setMenuSpeed('crazy')" id="menuCrazyBtn">Crazy</button>
        </div>
      </div>

      <button class="start-btn" onclick="startGame()">ðŸš€ Start Game</button>
    </div>
  </div>

  <!-- Game UI -->
  <div class="hud" id="hud">
    <div class="question" id="question">Ready?</div>
    <div class="score-primary" id="scorePrimary">Score: 0 â€¢ Round: 0</div>
    <div class="score-sub" id="scoreSub">Accuracy: 0% â€¢ Best: 0</div>
  </div>

  <div class="game-controls" id="gameControls">
    <button class="control-btn" onclick="pauseGame()" id="pauseBtn">Pause</button>
    <button class="control-btn" onclick="showMenu()">Menu</button>
    <button class="control-btn" onclick="toggleHelp()" aria-controls="helpOverlay" title="Help">?</button>
  </div>

  <div class="streak-indicator" id="streakIndicator">ðŸ”¥ Streak: 0</div>
  <!-- add just under the streak-indicator div -->
  <div class="streak-bar"><div id="streakFill"></div></div>
  <div class="feedback" id="feedback"></div>
  <div class="lives-indicator" id="livesIndicator"></div>

  <div class="stage" id="stage"></div>

  <!-- High score toast -->
  <div class="highscore-toast" id="highScoreToast">New High Score!</div>

  <!-- Help overlay -->
  <div class="help-overlay hidden" id="helpOverlay" onclick="toggleHelp()">
    <div class="help-panel" onclick="event.stopPropagation()">
      <h3>How to Play</h3>
      <p>Select the correct answer bubble before it falls.</p>
      <ul>
        <li>Keys 1â€“<span id="helpKeysMax">6</span>: pop bubbles leftâ†’right</li>
        <li>Space: pop the correct answer</li>
        <li>P: pause/resume â€¢ Esc: menu</li>
      </ul>
      <button class="menu-btn" onclick="toggleHelp()">Close</button>
    </div>
  </div>

  <script>
    // --- Game settings ---
    const difficulties = {
      easy: { min: 2, max: 5, name: 'Easy' },
      medium: { min: 2, max: 8, name: 'Medium' },
      hard: { min: 2, max: 12, name: 'Hard' }
    };

    const speeds = {
      slow: { duration: 8000, name: 'Slow' },
      normal: { duration: 6000, name: 'Normal' },
      fast: { duration: 4000, name: 'Fast' },
      crazy: { duration: 2500, name: 'Crazy' }
    };

    // Dynamic choices by viewport (fewer on narrow screens)
    function getChoicesCount() {
      if (window.matchMedia('(max-width: 360px)').matches) return 4;
      if (window.matchMedia('(max-width: 420px)').matches) return 5;
      return 6;
    }
    const SPAWN_DELAY = 800;
    const STREAK_THRESHOLD = 3;
    const MAX_LIVES = 3;

    // --- DOM Elements ---
    const stage = document.getElementById('stage');
    const qEl = document.getElementById('question');
    const scorePrimaryEl = document.getElementById('scorePrimary');
    const scoreSubEl = document.getElementById('scoreSub');
    const streakEl = document.getElementById('streakIndicator');
    const feedbackEl = document.getElementById('feedback');
    const livesEl = document.getElementById('livesIndicator');
    const menuOverlay = document.getElementById('menuOverlay');
    const hud = document.getElementById('hud');
    const gameControls = document.getElementById('gameControls');

    // --- State ---
    let score = 0;
    let rounds = 0;
    let correct = 0;
    let streak = 0;
    let lives = MAX_LIVES;
    let bestStreak = parseInt(localStorage.getItem('bestStreak') || '0');
    let highScore = parseInt(localStorage.getItem('highScore') || '0');
    let acceptingInput = true;
    let currentAnswer = null;
    let currentDifficulty = localStorage.getItem('difficulty') || 'easy';
    let currentSpeed = localStorage.getItem('speed') || 'normal';
    let gameActive = false;
    let gamePaused = false;
    let spawnTimeouts = [];
    let nextQuestionData = null;
    let questionHue = 200;

    // --- Utils ---
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const randFloat = (min, max) => Math.random() * (max - min) + min;

    function getRandomX(bubbleSize) {
    const stageWidth = window.innerWidth <= 768 ? 320 : 400;
    return randInt(0, Math.max(0, stageWidth - bubbleSize));
    }

    // --- Menu Functions ---
    function updateMenuStats() {
      document.getElementById('bestScoreStat').textContent = highScore;
      document.getElementById('bestStreakStat').textContent = bestStreak;
    }

    function setMenuDifficulty(level) {
      currentDifficulty = level;
      ['menuEasyBtn','menuMediumBtn','menuHardBtn'].forEach(id => {
        const el = document.getElementById(id); if (el) el.classList.remove('active');
      });
      const btnId = 'menu' + level.charAt(0).toUpperCase() + level.slice(1) + 'Btn';
      const el = document.getElementById(btnId); if (el) el.classList.add('active');
      localStorage.setItem('difficulty', currentDifficulty);
    }

    function setMenuSpeed(speed) {
      currentSpeed = speed;
      ['menuSlowBtn','menuNormalBtn','menuFastBtn','menuCrazyBtn'].forEach(id => {
        const el = document.getElementById(id); if (el) el.classList.remove('active');
      });
      const btnId = 'menu' + speed.charAt(0).toUpperCase() + speed.slice(1) + 'Btn';
      const el = document.getElementById(btnId); if (el) el.classList.add('active');
      localStorage.setItem('speed', currentSpeed);
    }

    function initPreferences() {
      setMenuDifficulty(currentDifficulty);
      setMenuSpeed(currentSpeed);
      const keysMax = document.getElementById('helpKeysMax');
      if (keysMax) keysMax.textContent = String(getChoicesCount());
    }

    function showMenu() {
      gameActive = false;
      gamePaused = true;
      const card = document.querySelector('.recap-card');
        if (card) card.remove();
      
      // Clear timeouts
      spawnTimeouts.forEach(timeout => clearTimeout(timeout));
      spawnTimeouts = [];
      
      // Hide game UI
      hud.classList.remove('visible');
      gameControls.classList.remove('visible');
      livesEl.classList.remove('visible');
      
      // Show menu
      menuOverlay.classList.remove('hidden');
      updateMenuStats();
    }

    function startGame() {
      // Hide menu
      menuOverlay.classList.add('hidden');
      
      // Show game UI
      setTimeout(() => {
        hud.classList.add('visible');
        gameControls.classList.add('visible');
        livesEl.classList.add('visible');
      }, 300);
      
      // Reset game state
      resetGame();
      
      // Start the game
      gameActive = true;
      gamePaused = false;
      
      // Preload the first question
      preloadNextQuestion();
      generateQuestion();
    }

    function pauseGame() {
      if (!gameActive) return;
      
      gamePaused = !gamePaused;
      const pauseBtn = document.getElementById('pauseBtn');
      
      if (gamePaused) {
        pauseBtn.textContent = 'Resume';
        // Pause all bubble animations
        stage.querySelectorAll('.bubble').forEach(bubble => {
          bubble.style.animationPlayState = 'paused';
        });
      } else {
        pauseBtn.textContent = 'Pause';
        // Resume all bubble animations
        stage.querySelectorAll('.bubble').forEach(bubble => {
          bubble.style.animationPlayState = 'running';
        });
      }
    }

    // --- Effects ---
    function makeRipple(x, y) {
      const ring = document.createElement('div');
      ring.className = 'ring';
      ring.style.left = x + 'px';
      ring.style.top = y + 'px';
      stage.appendChild(ring);
      setTimeout(() => ring.remove(), 320);
    }

    function makeParticles(x, y, baseSize, isStreak = false) {
      if (isStreak && streak >= 3) {
        // Epic explosion for streaks of 3+
        makeExplosion(x, y, baseSize);
      } else {
        // Regular particles
        const count = randInt(8, 12);
        for (let i = 0; i < count; i++) {
          const p = document.createElement('div');
          p.className = 'particle';
          p.style.left = x + 'px';
          p.style.top = y + 'px';

          const angle = randFloat(0, Math.PI * 2);
          const dist = randFloat(baseSize * 0.3, baseSize * 0.8);
          const dx = Math.cos(angle) * dist;
          const dy = Math.sin(angle) * dist;
          p.style.setProperty('--dx', dx.toFixed(1) + 'px');
          p.style.setProperty('--dy', dy.toFixed(1) + 'px');

          const hue = randInt(180, 220);
          const sat = randInt(60, 85);
          p.style.background = `radial-gradient(circle at 30% 30%, hsla(${hue},100%,98%,0.95), hsla(${hue}, ${sat}%, 70%, 0.9))`;

          stage.appendChild(p);
          setTimeout(() => p.remove(), 420);
        }
      }
    }

    function makeExplosion(x, y, baseSize) {
      // Screen shake effect
      document.body.classList.add('screen-shake');
      setTimeout(() => document.body.classList.remove('screen-shake'), 400);
      
      // Shockwave
      const shockwave = document.createElement('div');
      shockwave.className = 'shockwave';
      shockwave.style.left = x + 'px';
      shockwave.style.top = y + 'px';
      stage.appendChild(shockwave);
      setTimeout(() => shockwave.remove(), 600);
      
      // Fire particles
      const fireCount = randInt(15, 20);
      for (let i = 0; i < fireCount; i++) {
          const p = document.createElement('div');
          p.className = 'explosion-particle fire';
          p.style.left = x + 'px';
          p.style.top = y + 'px';

          const angle = randFloat(0, Math.PI * 2);
          const dist = randFloat(baseSize * 0.8, baseSize * 1.5);
          const dx = Math.cos(angle) * dist;
          const dy = Math.sin(angle) * dist;
          p.style.setProperty('--dx', dx.toFixed(1) + 'px');
          p.style.setProperty('--dy', dy.toFixed(1) + 'px');

          stage.appendChild(p);
          setTimeout(() => p.remove(), 800);
      }
      
      // Sparks
      const sparkCount = randInt(12, 18);
      for (let i = 0; i < sparkCount; i++) {
          const p = document.createElement('div');
          p.className = 'explosion-particle spark';
          p.style.left = x + 'px';
          p.style.top = y + 'px';

          const angle = randFloat(0, Math.PI * 2);
          const dist = randFloat(baseSize * 1.2, baseSize * 2);
          const dx = Math.cos(angle) * dist;
          const dy = Math.sin(angle) * dist;
          p.style.setProperty('--dx', dx.toFixed(1) + 'px');
          p.style.setProperty('--dy', dy.toFixed(1) + 'px');

          stage.appendChild(p);
          setTimeout(() => p.remove(), 900);
      }
      
      // Smoke clouds
      const smokeCount = randInt(6, 10);
      for (let i = 0; i < smokeCount; i++) {
          const p = document.createElement('div');
          p.className = 'explosion-particle smoke';
          p.style.left = x + 'px';
          p.style.top = y + 'px';

          const angle = randFloat(0, Math.PI * 2);
          const dist = randFloat(baseSize * 0.4, baseSize * 1);
          const dx = Math.cos(angle) * dist;
          const dy = Math.sin(angle) * dist;
          p.style.setProperty('--dx', dx.toFixed(1) + 'px');
          p.style.setProperty('--dy', dy.toFixed(1) + 'px');

          stage.appendChild(p);
          setTimeout(() => p.remove(), 1200);
      }
    }

    function stageFlash() {
      const f = document.createElement('div');
      f.className = 'flash';
      stage.appendChild(f);
      setTimeout(() => f.remove(), 240);
    }

    function showFeedback(text, isCorrect) {
      feedbackEl.textContent = text;
      feedbackEl.style.color = isCorrect ? 'var(--correct)' : 'var(--wrong)';
      feedbackEl.classList.add('show');
      setTimeout(() => feedbackEl.classList.remove('show'), 600);
    }

    function showAnswerReveal(answer) {
      const reveal = document.createElement('div');
      reveal.className = 'answer-reveal';
      reveal.textContent = `Answer: ${answer}`;
      reveal.style.left = '50%';
      reveal.style.top = '40%';
      reveal.style.transform = 'translateX(-50%)';
      stage.appendChild(reveal);
      setTimeout(() => reveal.remove(), 1500);
    }

    // Special milestone celebrations
    function celebrateMilestone(count) {
      const celebration = document.createElement('div');
      celebration.className = `milestone-celebration milestone-${count}`;
      
      const text = document.createElement('div');
      text.className = 'milestone-text';
      
      if (count === 7) {
        text.textContent = '7 in a row!\nAmazing!';
      } else if (count === 10) {
        text.textContent = '10 in a row!\nIncredible!';
      } else if (count === 15) {
        text.textContent = '15 in a row!\nUnstoppable!';
      }
      
      celebration.appendChild(text);
      
      // Add confetti
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${randInt(0, 100)}%`;
        confetti.style.top = '-10px';
        confetti.style.setProperty('--confetti-color', `hsl(${randInt(0, 360)}, 100%, 50%)`);
        confetti.style.animationDuration = `${randFloat(1, 3)}s`;
        confetti.style.animationDelay = `${randFloat(0, 0.5)}s`;
        celebration.appendChild(confetti);
      }
      
      // Add fireworks
      for (let i = 0; i < 10; i++) {
        setTimeout(() => {
          const startX = randInt(20, 80);
          const startY = randInt(20, 80);
          
          for (let j = 0; j < 20; j++) {
            const firework = document.createElement('div');
            firework.className = 'firework';
            firework.style.left = `${startX}%`;
            firework.style.top = `${startY}%`;
            firework.style.backgroundColor = `hsl(${randInt(0, 360)}, 100%, 60%)`;
            
            const angle = randFloat(0, Math.PI * 2);
            const distance = randFloat(30, 100);
            const endX = Math.cos(angle) * distance;
            const endY = Math.sin(angle) * distance;
            
            firework.style.setProperty('--startX', `0px`);
            firework.style.setProperty('--startY', `0px`);
            firework.style.setProperty('--endX', `${endX}px`);
            firework.style.setProperty('--endY', `${endY}px`);
            
            celebration.appendChild(firework);
          }
        }, i * 100);
      }
      
      document.body.appendChild(celebration);
      setTimeout(() => {
        celebration.remove();
      }, 2500);
    }

    // --- Lives system ---
    function updateLives() {
      livesEl.innerHTML = '';
      for (let i = 0; i < MAX_LIVES; i++) {
        const heart = document.createElement('div');
        heart.className = i >= lives ? 'heart lost' : 'heart';
        livesEl.appendChild(heart);
      }
    }

    function loseLife() {
      lives--;
      updateLives();
        if (lives <= 0) {
            gameOver();
        }
    }

    function gameOver() {
      gameActive = false;
      acceptingInput = false;

      // Clear all timeouts and bubbles
      spawnTimeouts.forEach(timeout => clearTimeout(timeout));
      spawnTimeouts = [];
      stage.querySelectorAll('.bubble').forEach(bubble => bubble.remove());

      showFeedback(`Game Over! Final Score: ${score}`, false);

      // Show menu after a delay
      setTimeout(() => {
        showMenu();
      }, 2000);
    }

    // --- Bubble creation ---
function createBubble(value, isAnswer, isPowerUp = false, delay = 0, questionId, paletteFilter = '') {
    if (!gameActive) return;

    const timeout = setTimeout(() => {
        if (!gameActive || gamePaused) return;

        const bubble = document.createElement('div');
        bubble.className = isPowerUp ? 'bubble power-up falling' : 'bubble falling';
        bubble.dataset.value = String(value);
        bubble.dataset.answer = isAnswer ? '1' : '0';
        bubble.dataset.powerUp = isPowerUp ? '1' : '0';
        bubble.dataset.questionId = questionId;

        const size = randInt(60, 80);
        bubble.style.width = size + 'px';
        bubble.style.height = size + 'px';
        bubble.style.left = getRandomX(size) + 'px';
        bubble.style.top = '-150px';

        const fallDuration = speeds[currentSpeed].duration;
        bubble.style.animationDuration = fallDuration + 'ms';

        // colour-coded per question (palette passed from generateQuestion)
        bubble.style.filter = isPowerUp ? '' : paletteFilter;

        // label (6/9 underlined)
        const label = document.createElement('div');
        label.className = 'label';
        if (value === 6 || value === 9 || String(value).includes('6') || String(value).includes('9')) label.classList.add('underlined');
        label.textContent = isPowerUp ? 'âœ¨' : value;
        bubble.appendChild(label);

        // micro click-wave on every press
        bubble.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            const bRect = bubble.getBoundingClientRect();
            const sRect = stage.getBoundingClientRect();
            const cx = bRect.left - sRect.left + bRect.width / 2;
            const cy = bRect.top - sRect.top + bRect.height / 2;
            const wave = document.createElement('div');
            wave.className = 'click-wave';
            wave.style.left = cx + 'px';
            wave.style.top = cy + 'px';
            stage.appendChild(wave);
            setTimeout(() => wave.remove(), 300);
            onBubbleClick(bubble, size);
        });

        stage.appendChild(bubble);

        /* ----- ghost bubble if correct answer falls off ----- */
        setTimeout(() => {
            if (!bubble.parentNode || !gameActive || gamePaused) return;
            const bubQ = parseInt(bubble.dataset.questionId);
            if (bubQ === rounds && isAnswer) {
                loseLife(); streak = 0; rounds++; updateScore();
                showFeedback('Missed!', false); showAnswerReveal(currentAnswer); stageFlash();
                const ghost = document.createElement('div'); ghost.className = 'ghost';
                ghost.style.left = bubble.style.left;
                ghost.style.top = (window.innerHeight - 90) + 'px';
                stage.appendChild(ghost); setTimeout(() => ghost.remove(), 1000);
                setTimeout(() => { if (gameActive) generateQuestion(); }, 300);
            }
            bubble.remove();
        }, fallDuration + 100);

    }, delay);

    spawnTimeouts.push(timeout);
}

    // Preload next question data
    function preloadNextQuestion() {
      const diff = difficulties[currentDifficulty];
      const a = randInt(diff.min, diff.max);
      const b = randInt(diff.min, diff.max);
      const product = a * b;

      const set = new Set([product]);
      const choiceCount = getChoicesCount();

      // Generate plausible wrong answers
      const neighbours = [
        a * (b - 1), a * (b + 1),
        (a - 1) * b, (a + 1) * b,
        product - a, product + a,
        product - b, product + b,
      ].filter(n => Number.isFinite(n) && n > 0);

      for (const n of neighbours) if (set.size < choiceCount) set.add(n);

      while (set.size < choiceCount) {
        const x = randInt(diff.min, diff.max);
        const y = randInt(diff.min, diff.max);
        if (x * y !== product) set.add(x * y);
      }

      const choices = Array.from(set).sort(() => Math.random() - 0.5);

      // Sometimes add a power-up bubble (15% chance when streak >= 3)
      const shouldAddPowerUp = streak >= 3 && Math.random() < 0.15;

      nextQuestionData = {
        a, b, product, choices, shouldAddPowerUp
      };
    }

function generateQuestion() {
    if (!gameActive || gamePaused) return;

    // use pre-loaded data (or create it)
    if (!nextQuestionData) preloadNextQuestion();
    const { a, b, product, choices, shouldAddPowerUp } = nextQuestionData;
    currentAnswer = product;

    // update UI
    qEl.textContent = `${a} Ã— ${b} = ?`;
    questionHue = (questionHue + 40) % 360;
    document.documentElement.style.setProperty('--question-hue', `${questionHue}deg`);

    /* ----- expire old bubbles (visual + DOM clean-up) ----- */
    stage.querySelectorAll('.bubble').forEach(bub => {
        const bubQ = parseInt(bub.dataset.questionId);
        if (bubQ < rounds) bub.classList.add('expired');
    });
    setTimeout(() => stage.querySelectorAll('.bubble.expired').forEach(b => b.remove()), 600);

    /* ----- spawn new bubble set (with colour palette) ----- */
    const palette = [
        'hue-rotate(0deg) saturate(1.1)',
        'hue-rotate(60deg) saturate(1.2)',
        'hue-rotate(160deg) saturate(1.1)',
        'hue-rotate(220deg) saturate(1.3)',
        'hue-rotate(280deg) saturate(1.2)'
    ];
    choices.forEach((val, idx) => {
        const isAnswer = val === product;
        const isPowerUp = shouldAddPowerUp && isAnswer;
        const delay = idx * SPAWN_DELAY;

        // pass palette filter down so createBubble can use it
        createBubble(val, isAnswer, isPowerUp, delay, rounds, palette[rounds % palette.length]);
    });

    preloadNextQuestion(); // preload next while player plays
}

    function onBubbleClick(bubble, size) {
    if (!acceptingInput || !gameActive || gamePaused) return;

    // 1. calculate centre FIRST
    const bRect = bubble.getBoundingClientRect();
    const sRect = stage.getBoundingClientRect();
    const cx = bRect.left - sRect.left + bRect.width / 2;
    const cy = bRect.top - sRect.top + bRect.height / 2;

    // 2. micro click-wave (now safe)
    const wave = document.createElement('div');
    wave.className = 'click-wave';
    wave.style.left = cx + 'px';
    wave.style.top = cy + 'px';
    stage.appendChild(wave);
    setTimeout(() => wave.remove(), 300);

    // 3. game logic
    const value = parseInt(bubble.dataset.value);
    const isCorrect = value === currentAnswer;
    const isPowerUp = bubble.dataset.powerUp === '1';

    // Haptics (if supported)
    if (navigator.vibrate) {
      if (isCorrect) navigator.vibrate(20); else navigator.vibrate([60,30,30]);
    }

    if (isCorrect) {
        acceptingInput = false;
        const points = isPowerUp ? 3 : 1;
        score += points; correct++; streak++; rounds++;
        if (streak === 7 || streak === 10 || streak === 15) celebrateMilestone(streak);
        if (streak > bestStreak) {
        bestStreak = streak;
        localStorage.setItem('bestStreak', bestStreak);
        }
        updateScore();
        makeRipple(cx, cy);
        makeParticles(cx, cy, bRect.width, streak >= STREAK_THRESHOLD);
        bubble.classList.remove('falling');
        bubble.classList.add('correct');
        showFeedback(isPowerUp ? `Power Up! +${points} points!` : streak >= STREAK_THRESHOLD ? `${streak} streak!` : 'Correct!', true);
        setTimeout(() => bubble.remove(), 300);
        stageFlash();
        setTimeout(() => { if (gameActive) { acceptingInput = true; generateQuestion(); } }, 500);
    } else {
        streak = 0; loseLife(); updateScore();
        bubble.classList.remove('falling');
        bubble.classList.add('wrong');
        showFeedback('Wrong!', false);
        setTimeout(() => bubble.remove(), 400);
        stageFlash();
    }
    }


    function updateScore() {
        // in updateScore()
        const hue = 160 + Math.min(140, score / 3); // 160-300 deg
        document.body.style.setProperty('--hue', hue);
      const acc = rounds ? Math.round((correct / rounds) * 100) : 0;
      if (scorePrimaryEl) scorePrimaryEl.textContent = `Score: ${score} â€¢ Round: ${rounds}`;
      if (scoreSubEl) scoreSubEl.textContent = `Accuracy: ${acc}% â€¢ Best: ${highScore}`;
        // in updateScore()
        const percent = Math.min(100, (streak / 3) * 100);
        const bar = document.getElementById('streakFill');
        bar.style.width = percent + '%';
        document.querySelector('.streak-bar').classList.toggle('show', streak > 0);
      if (score > highScore) {
        highScore = score;
        localStorage.setItem('highScore', highScore.toString());
        const toast = document.getElementById('highScoreToast');
        if (toast) { toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 1200); }
      }

      // Update streak indicator
      if (streak >= STREAK_THRESHOLD) {
        streakEl.textContent = `ðŸ”¥ Streak: ${streak} (Best: ${bestStreak})`;
        streakEl.classList.add('show');
      } else {
        streakEl.classList.remove('show');
      }
    }
    function gameOver() {
        gameActive = false;
        acceptingInput = false;
        spawnTimeouts.forEach(t => clearTimeout(t));
        spawnTimeouts = [];
        stage.querySelectorAll('.bubble').forEach(b => b.remove());

        // Recap card
        const card = document.createElement('div');
        card.className = 'recap-card';
        card.innerHTML = `
            <h2>Great job!</h2>
            <p>Score <b>${score}</b></p>
            <p>Best streak <b>${streak}</b></p>
            <p>Accuracy <b>${Math.round((correct/rounds)*100)||0}%</b></p>
            <button onclick="showMenu()">Menu</button>
        `;
        document.body.appendChild(card);

        // Animate in
        requestAnimationFrame(() => card.classList.add('show'));
        // remove recap card after 4 s (or tweak to taste)
        setTimeout(() => {
        const card = document.querySelector('.recap-card');
        if (card) card.remove();
        }, 4000);
    }

    function resetGame() {
      // Clear timeouts
      spawnTimeouts.forEach(timeout => clearTimeout(timeout));
      spawnTimeouts = [];

      // Reset state
      score = 0;
      rounds = 0;
      correct = 0;
      streak = 0;
      lives = MAX_LIVES;
      acceptingInput = true;
      gamePaused = false;
      nextQuestionData = null;
      questionHue = 200;

      // Clear stage
      stage.querySelectorAll('.bubble').forEach(b => b.remove());

      updateScore();
      updateLives();

      qEl.textContent = 'Ready?';
      document.getElementById('pauseBtn').textContent = 'Pause';
    }

    // --- Keyboard controls ---
    document.addEventListener('keydown', (e) => {
      if (!gameActive || gamePaused) return;

      const maxKey = getChoicesCount();
      if (e.key >= '1' && e.key <= String(maxKey)) {
        const bubbles = Array.from(stage.querySelectorAll('.bubble'))
          .filter(b => parseInt(b.dataset.questionId) === rounds);
        const index = parseInt(e.key) - 1;
        if (bubbles[index]) {
            bubbles[index].click();
        }
      } else if (e.key === ' ') {
        e.preventDefault();
        // Space bar clicks the correct answer bubble
        const correctBubble = stage.querySelector('.bubble[data-answer="1"][data-question-id="' + rounds + '"]');
        if (correctBubble) {
            correctBubble.click();
        }
      } else if (e.key === 'p' || e.key === 'P') {
        pauseGame();
      } else if (e.key === 'Escape') {
        showMenu();
      }
    });

    // Prevent context menu on touch devices
    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
    });

    // --- Resize safety ---
    window.addEventListener('resize', () => {
      const sw = stage.clientWidth;
      stage.querySelectorAll('.bubble').forEach(b => {
        const w = b.offsetWidth;
        const currentX = parseFloat(b.style.left) || 0;
        const newX = Math.min(currentX, Math.max(0, sw - w));
        b.style.left = newX + 'px';
      });
    });

    function toggleHelp() {
      const el = document.getElementById('helpOverlay');
      el.classList.toggle('hidden');
      // refresh key hint
      const keysMax = document.getElementById('helpKeysMax');
      if (keysMax) keysMax.textContent = String(getChoicesCount());
    }

    // --- Initialize ---
    initPreferences();
    updateMenuStats();
    resetGame();
  </script>
</body>
</html>

