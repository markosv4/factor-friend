<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Falling Bubble Multiplication</title>
  <style>
    :root {
      --bg1: #a8edea;
      --bg2: #fed6e3;
      --text: #0b2a2f;
      --correct: #4ade80;
      --wrong: #ef4444;
      --streak: #f59e0b;
      --question-hue: 200;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background: linear-gradient(to top, var(--bg1), var(--bg2));
      overflow: hidden;
      user-select: none;
      background: linear-gradient(to top, hsl(var(--hue, 200), 60%, 85%), hsl(calc(var(--hue, 200) + 30), 70%, 92%));
      transition: background 1s;
    }

    /* Main Menu Styles */
    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: opacity 0.3s ease;
    }

    .menu-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* Help overlay */
    .help-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 12;
      transition: opacity 0.25s ease;
    }
    .help-overlay.hidden { opacity: 0; pointer-events: none; }
    .help-panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 20px 24px;
      max-width: 420px;
      width: 92vw;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      color: var(--text);
    }
    .help-panel h3 { margin: 0 0 6px; }
    .help-panel ul { margin: 8px 0 16px; padding-left: 18px; }
    .help-panel li { margin: 4px 0; }

    .menu-panel {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      text-align: center;
      max-width: 400px;
      width: 90%;
      transform: scale(1);
      transition: transform 0.3s ease;
    }

    .menu-overlay.hidden .menu-panel {
      transform: scale(0.9);
    }

    .menu-title {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 10px;
      background: linear-gradient(45deg, var(--correct), var(--streak));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .menu-subtitle {
      font-size: 16px;
      opacity: 0.7;
      margin-bottom: 30px;
    }

    .menu-section {
      margin-bottom: 25px;
    }

    .menu-section h3 {
      font-size: 18px;
      margin-bottom: 15px;
      color: var(--text);
    }

    .menu-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .menu-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.7);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      min-width: 80px;
    }

    .menu-btn:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .menu-btn.active {
      background: var(--correct);
      color: white;
      transform: translateY(-1px);
    }

    .start-btn {
      background: linear-gradient(45deg, var(--correct), var(--streak));
      color: white;
      font-size: 18px;
      font-weight: 700;
      padding: 15px 40px;
      border-radius: 25px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      margin-top: 20px;
    }

    .start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .stats-section {
      background: rgba(255, 255, 255, 0.5);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      text-align: center;
    }

    .stat-item {
      font-size: 14px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--streak);
    }

    .stat-label {
      opacity: 0.7;
      font-size: 12px;
    }

    /* Game UI Styles */
    .hud {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
      padding: 8px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(12px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      z-index: 3;
      opacity: 0;
      transition: opacity 0.3s ease;
      max-width: 90vw;
    }

    .hud.visible {
      opacity: 1;
    }

    .question {
      font-weight: 800;
      letter-spacing: 0.5px;
      font-size: clamp(16px, 4vw, 24px);
      text-align: center;
    }

    .score-primary { 
      font-weight: 700; 
      font-size: clamp(12px, 3vw, 16px);
      text-align: center;
    }
    
    .score-sub { 
      font-weight: 600; 
      font-size: clamp(10px, 2.5vw, 14px); 
      opacity: 0.75;
      text-align: center;
    }

    .game-controls {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 3;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .game-controls.visible {
      opacity: 1;
    }

    .control-btn {
      padding: 6px 10px;
      border: none;
      border-radius: 16px;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(4px);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 11px;
      min-width: 50px;
    }

    .control-btn:hover {
      background: rgba(255,255,255,0.95);
      transform: translateY(-1px);
    }

    .streak-indicator {
      position: absolute;
      top: 80px;
      right: 8px;
      padding: 6px 10px;
      border-radius: 16px;
      background: linear-gradient(45deg, var(--streak), #fbbf24);
      color: white;
      font-weight: 700;
      font-size: 12px;
      transform: scale(0);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 3;
    }

    .streak-indicator.show {
      transform: scale(1);
    }

    .feedback {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: clamp(24px, 6vw, 36px);
      font-weight: 800;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      opacity: 0;
      pointer-events: none;
      z-index: 4;
      text-align: center;
    }

    .feedback.show {
      animation: feedbackPop 0.6s ease-out;
    }

    @keyframes feedbackPop {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      30% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
    }

    .stage {
      position: relative;
      width: min(400px, calc(100vw - 20px));
      height: 100vh;
      overflow: hidden;
      margin: 0 auto;
      border-left: 2px solid rgba(255, 255, 255, 0.3);
      border-right: 2px solid rgba(255, 255, 255, 0.3);
    }

    .bubble {
      position: absolute;
      left: 0; top: 0;
      width: 70px; height: 70px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(173,216,230,0.7) 60%, rgba(135,206,235,0.4) 100%);
      box-shadow:
          inset -6px -6px 12px rgba(255,255,255,0.65),
          inset 8px 8px 14px rgba(0,0,0,0.08),
          0 10px 20px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: transform 120ms ease;
      will-change: transform, filter, opacity;
      display: grid;
      place-items: center;
      padding: 6px;
    }
    
    .bubble:hover { transform: scale(1.05); }
    .bubble:active { transform: scale(0.95); }

    .bubble.falling {
      animation: fall linear forwards;
      animation-duration: var(--fallMs, 6000ms);
    }

    @keyframes fall {
      0%   { transform: translateY(-150px) rotateZ(0deg) translateX(0); opacity: 0; }
      6%   { opacity: 1; }
      28%  { transform: translateY(27vh)  rotateZ(100deg) translateX(6px); }
      44%  { transform: translateY(43vh)  rotateZ(160deg) translateX(0); }
      52%  { transform: translateY(50vh)  rotateZ(200deg) translateX(-2px); }
      62%  { transform: translateY(56vh)  rotateZ(240deg) translateX(0); }
      78%  { transform: translateY(76vh)  rotateZ(300deg) translateX(-6px); }
      100% { transform: translateY(calc(100vh + 150px)) rotateZ(360deg) translateX(0); opacity: 0; }
    }

    .bubble.power-up {
      background: radial-gradient(circle at 30% 30%, rgba(255,215,0,0.9), rgba(255,140,0,0.7) 60%, rgba(255,69,0,0.4) 100%);
      box-shadow:
        inset -6px -6px 12px rgba(255,255,255,0.65),
        inset 8px 8px 14px rgba(255,140,0,0.15),
        0 10px 20px rgba(255,140,0,0.2),
        0 0 30px rgba(255,215,0,0.3);
      animation: fall linear forwards, powerGlow 2s ease-in-out infinite;
      animation-duration: var(--fallMs, 6000ms), 2000ms;
    }

    @keyframes powerGlow {
      0%, 100% { 
        box-shadow: 
          inset -6px -6px 12px rgba(255,255,255,0.65), 
          inset 8px 8px 14px rgba(255,140,0,0.15), 
          0 10px 20px rgba(255,140,0,0.2), 
          0 0 30px rgba(255,215,0,0.3); 
      }
      50% { 
        box-shadow: 
          inset -6px -6px 12px rgba(255,255,255,0.65), 
          inset 8px 8px 14px rgba(255,140,0,0.15), 
          0 10px 20px rgba(255,140,0,0.2), 
          0 0 50px rgba(255,215,0,0.5); 
      }
    }

    .bubble::before {
      content: "";
      position: absolute;
      left: 18%; top: 18%;
      width: 35%; height: 35%;
      background: radial-gradient(circle, rgba(255,255,255,0.95), rgba(255,255,255,0) 60%);
      border-radius: 50%;
      filter: blur(0.5px);
      pointer-events: none;
    }

    .label {
      position: relative;
      z-index: 1;
      font-weight: 800;
      font-size: 18px;
      letter-spacing: 0.5px;
      color: #114b5f;
      text-shadow: 0 1px 0 rgba(255,255,255,0.7);
      user-select: none;
      pointer-events: none;
    }

    .label.underlined {
      text-decoration: underline;
      text-decoration-thickness: 2px;
      text-underline-offset: 2px;
    }

    .bubble.power-up .label {
      color: #8b4513;
      text-shadow: 0 1px 0 rgba(255,255,255,0.9);
    }

    .bubble.correct {
      animation: popAndFall 0.3s ease-out forwards;
      filter: saturate(1.2) brightness(1.1);
    }

    @keyframes popAndFall {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.9; filter: blur(0.2px); }
      100% { transform: scale(0.3); opacity: 0; filter: blur(0.5px); }
    }

    .bubble.wrong {
      animation: wrongShake 0.4s ease-out forwards;
      filter: hue-rotate(330deg) saturate(1.2) brightness(1.05);
      box-shadow:
        inset -4px -6px 10px rgba(255,255,255,0.5),
        inset 8px 10px 16px rgba(255,0,0,0.15),
        0 10px 22px rgba(255,0,0,0.10);
    }

    @keyframes wrongShake {
      0%, 100% { transform: translateX(0); opacity: 1; }
      20% { transform: translateX(-5px); }
      40% { transform: translateX(5px); }
      60% { transform: translateX(-3px); }
      80% { transform: translateX(3px); opacity: 0.7; }
      100% { transform: translateX(0); opacity: 0; }
    }

    .ring {
      position: absolute;
      width: 14px; height: 14px;
      margin-left: -7px; margin-top: -7px;
      border: 3px solid rgba(255,255,255,0.9);
      border-radius: 999px;
      pointer-events: none;
      animation: ripple 300ms ease-out forwards;
      box-shadow: 0 0 10px rgba(255,255,255,0.6);
      z-index: 2;
    }
    @keyframes ripple {
      from { transform: scale(0.25); opacity: 0.9; border-width: 3px; }
      to   { transform: scale(5);    opacity: 0;   border-width: 1px; }
    }

    .particle {
      position: absolute;
      width: 8px; height: 8px;
      margin-left: -4px; margin-top: -4px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), rgba(135,206,235,0.9));
      pointer-events: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      animation: shoot 380ms cubic-bezier(.15,.6,.2,1) forwards;
      z-index: 2;
    }
    @keyframes shoot {
      from { transform: translate3d(0,0,0) scale(1); opacity: 1; }
      to   { transform: translate3d(var(--dx, 0px), var(--dy, 0px), 0) scale(0.5); opacity: 0; }
    }

    .particle.streak {
      background: radial-gradient(circle at 30% 30%, rgba(255,215,0,0.95), rgba(255,140,0,0.9));
    }

    .flash {
      position: absolute; inset: 0;
      background: radial-gradient(ellipse at 50% 40%, rgba(255,255,255,0.45), rgba(255,255,255,0) 60%);
      pointer-events: none;
      animation: flash 220ms ease-out forwards;
      z-index: 1;
    }
    @keyframes flash {
      from { opacity: 0.45; }
      to   { opacity: 0; }
    }

    .answer-reveal {
      position: absolute;
      color: var(--wrong);
      font-weight: 800;
      font-size: 24px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      pointer-events: none;
      animation: revealAnswer 1.5s ease-out forwards;
      z-index: 3;
    }

    @keyframes revealAnswer {
      0% { opacity: 0; transform: translateY(0) scale(0.8); }
      30% { opacity: 1; transform: translateY(-20px) scale(1); }
      100% { opacity: 0; transform: translateY(-40px) scale(0.9); }
    }

    .lives-indicator {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 3;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .lives-indicator.visible {
      opacity: 1;
    }

    .highscore-toast {
      position: absolute;
      top: 64px;
      left: 50%;
      transform: translateX(-50%) translateY(6px);
      background: linear-gradient(45deg, var(--correct), var(--streak));
      color: #fff;
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.18);
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s, transform .25s;
      z-index: 5;
    }
    .highscore-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    .heart {
      width: 30px;
      height: 30px;
      background: var(--wrong);
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      transform: rotate(-45deg);
      position: relative;
      transition: all 0.3s ease;
    }

    .heart.lost {
      background: #ccc;
      transform: rotate(-45deg) scale(0.7);
      opacity: 0.5;
    }

    .heart::before,
    .heart::after {
      content: '';
      width: 26px;
      height: 40px;
      position: absolute;
      left: 15px;
      top: -20px;
      background: var(--wrong);
      border-radius: 25px 25px 0 0;
      transform: rotate(-45deg);
      transform-origin: 0 100%;
    }

    .heart.lost::before,
    .heart.lost::after {
      background: #ccc;
    }

    .heart::after {
      left: 0;
      transform: rotate(45deg);
      transform-origin: 100% 100%;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .stage {
        width: min(380px, calc(100vw - 20px));
      }
      
      .bubble {
        width: 65px;
        height: 65px;
      }
      
      .label {
        font-size: 16px;
      }
      
      .menu-panel {
        padding: 30px 20px;
      }
      
      .menu-title {
        font-size: 24px;
      }
      
      .menu-btn {
        font-size: 12px;
        padding: 10px 15px;
        min-width: 60px;
      }
      
      .heart {
        width: 25px;
        height: 25px;
      }

      .hud {
        top: 4px;
        padding: 6px 10px;
        gap: 2px;
      }

      .game-controls {
        top: 4px;
        right: 4px;
      }

      .streak-indicator {
        top: 60px;
        right: 4px;
        font-size: 11px;
        padding: 4px 8px;
      }
    }

    /* Removed the problematic mobile animation override */
    
    /* Epic explosion effects */
    .explosion-particle {
      position: absolute;
      width: 12px; 
      height: 12px;
      margin-left: -6px; 
      margin-top: -6px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 2;
    }

    .explosion-particle.fire {
      background: radial-gradient(circle, #ff6b35, #f7931e);
      box-shadow: 0 0 10px #ff6b35;
      animation: fireExplode 0.8s cubic-bezier(.25,.46,.45,.94) forwards;
    }

    .explosion-particle.spark {
      background: radial-gradient(circle, #ffd700, #ffff00);
      box-shadow: 0 0 8px #ffd700;
      animation: sparkExplode 0.9s cubic-bezier(.25,.46,.45,.94) forwards;
    }

    .explosion-particle.smoke {
      background: radial-gradient(circle, rgba(200,200,200,0.8), rgba(150,150,150,0.3));
      animation: smokeExplode 1.2s ease-out forwards;
    }

    @keyframes fireExplode {
      0% { 
        transform: translate3d(0,0,0) scale(0.3) rotate(0deg); 
        opacity: 1; 
      }
      30% { 
        transform: translate3d(var(--dx), var(--dy), 0) scale(1.2) rotate(180deg); 
        opacity: 0.9; 
      }
      100% { 
        transform: translate3d(calc(var(--dx) * 2), calc(var(--dy) * 2), 0) scale(0.1) rotate(360deg); 
        opacity: 0; 
      }
    }

    @keyframes sparkExplode {
      0% { 
        transform: translate3d(0,0,0) scale(0.5) rotate(0deg); 
        opacity: 1; 
      }
      40% { 
        transform: translate3d(var(--dx), var(--dy), 0) scale(1) rotate(270deg); 
        opacity: 1; 
      }
      100% { 
        transform: translate3d(calc(var(--dx) * 1.8), calc(var(--dy) * 1.8), 0) scale(0.2) rotate(540deg); 
        opacity: 0; 
      }
    }

    @keyframes smokeExplode {
      0% { 
        transform: translate3d(0,0,0) scale(0.2); 
        opacity: 0.6; 
      }
      50% { 
        transform: translate3d(calc(var(--dx) * 0.5), calc(var(--dy) * 0.5), 0) scale(2); 
        opacity: 0.3; 
      }
      100% { 
        transform: translate3d(var(--dx), var(--dy), 0) scale(3); 
        opacity: 0; 
      }
    }

    .shockwave {
      position: absolute;
      border: 4px solid rgba(255, 215, 0, 0.8);
      border-radius: 50%;
      pointer-events: none;
      animation: shockwaveExpand 0.6s ease-out forwards;
      z-index: 2;
    }

    @keyframes shockwaveExpand {
      0% { 
        width: 20px; 
        height: 20px; 
        margin-left: -10px; 
        margin-top: -10px; 
        opacity: 1; 
        border-width: 4px; 
      }
      100% { 
        width: 200px; 
        height: 200px; 
        margin-left: -100px; 
        margin-top: -100px; 
        opacity: 0; 
        border-width: 1px; 
      }
    }

    .screen-shake {
      animation: screenShake 0.4s ease-in-out;
    }

    @keyframes screenShake {
      0%, 100% { transform: translateX(0); }
      10% { transform: translateX(-3px) translateY(1px); }
      20% { transform: translateX(3px) translateY(-1px); }
      30% { transform: translateX(-2px) translateY(2px); }
      40% { transform: translateX(2px) translateY(-2px); }
      50% { transform: translateX(-1px) translateY(1px); }
      60% { transform: translateX(1px) translateY(-1px); }
      70% { transform: translateX(-2px) translateY(0px); }
      80% { transform: translateX(2px) translateY(0px); }
      90% { transform: translateX(-1px) translateY(0px); }
    }

    /* Special milestone animations */
    .milestone-celebration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 20;
      animation: fadeOut 1.5s ease-in forwards;
      animation-delay: 1s;
    }

    @keyframes fadeOut {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }

    .milestone-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 48px;
      font-weight: 900;
      text-align: center;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
      animation: textPulse 1.5s ease-out;
    }

    @keyframes textPulse {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: var(--confetti-color, #f00);
      animation: confettiFall linear forwards;
    }

    @keyframes confettiFall {
      0% { 
        transform: translateY(-20px) rotate(0deg); 
        opacity: 1;
      }
      90% { 
        opacity: 1;
      }
      100% { 
        transform: translateY(100vh) rotate(360deg); 
        opacity: 0;
      }
    }

    .firework {
      position: absolute;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      animation: fireworkExplode 0.8s ease-out forwards;
    }

    @keyframes fireworkExplode {
      0% { 
        transform: translate(var(--startX), var(--startY)) scale(0);
        opacity: 1;
      }
      100% { 
        transform: translate(var(--endX), var(--endY)) scale(1);
        opacity: 0;
      }
    }

    .star-burst {
      position: absolute;
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, #ffdd00, transparent 70%);
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: starBurst 1s ease-out forwards;
      opacity: 0;
    }

    @keyframes starBurst {
      0% { 
        transform: translate(-50%, -50%) scale(0);
        opacity: 1;
      }
      100% { 
        transform: translate(-50%, -50%) scale(3);
        opacity: 0;
      }
    }

    /* Special milestone specific styles */
    .milestone-7 .milestone-text {
      color: #ff6b6b;
      background: linear-gradient(45deg, #ff6b6b, #ff8e53);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .milestone-10 .milestone-text {
      color: #4ecdc4;
      background: linear-gradient(45deg, #4ecdc4, #556270);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .milestone-15 .milestone-text {
      color: #ffd93d;
      background: linear-gradient(45deg, #ffd93d, #ff6b6b);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .bubble.expired {
      opacity: 0.3;
      filter: grayscale(.6) blur(.6px);
      pointer-events: none;
      transition: opacity .4s, filter .4s;
    }

    .click-wave {
      position: absolute;
      width: 20px; height: 20px;
      margin: -10px 0 0 -10px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,.9) 0%, transparent 70%);
      pointer-events: none;
      animation: clickPop 300ms ease-out forwards;
      z-index: 5;
    }
    @keyframes clickPop {
      0%   { transform: scale(0.2); opacity: 1; }
      100% { transform: scale(3);   opacity: 0; }
    }

    .ghost {
      position: absolute;
      width: 70px; height: 70px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,.15), transparent 60%);
      box-shadow: 0 0 0 2px rgba(255,255,255,.3);
      pointer-events: none;
      animation: ghostLift 1s ease-out forwards;
      z-index: 1;
    }
    @keyframes ghostLift {
      0%   { transform: translateY(0); opacity: .6; }
      100% { transform: translateY(-80px); opacity: 0; }
    }

    .streak-bar {
      position: absolute;
      top: 108px;
      right: 20px;
      width: 120px; height: 6px;
      background: rgba(255,255,255,.4);
      border-radius: 3px;
      overflow: hidden;
      opacity: 0;
      transition: opacity .3s;
    }
    .streak-bar.show { opacity: 1; }
    #streakFill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #fbbf24, #f59e0b);
      transition: width .25s;
    }

    .recap-card {
      position: fixed;
      inset: 0;
      margin: auto;
      width: 260px; height: 180px;
      background: rgba(255,255,255,.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
      text-align: center;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      z-index: 25;
      transform: scale(.8);
      opacity: 0;
      transition: .4s;
    }
    .recap-card.show { transform: scale(1); opacity: 1; }
    .recap-card button {
      margin-top: 12px;
      padding: 8px 20px;
      border: none;
      border-radius: 12px;
      background: var(--correct);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }

    /* Special bubbles – brighter + aura */
    .bubble.special {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.8) 50%, rgba(255,255,255,.15) 100%);
      box-shadow:
        inset -6px -6px 12px rgba(255,255,255,0.7),
        inset 8px 8px 14px rgba(0,0,0,0.05),
        0 0 20px var(--special-glow, rgba(255,255,255,.4)),
        0 0 36px var(--special-glow, rgba(255,255,255,.25));
      animation: fall linear forwards, auraPulse 1.4s ease-in-out infinite;
      animation-duration: var(--fallMs, 6000ms), 1400ms;
    }

    .bubble.special .label { color:#0b2a2f; text-shadow: 0 1px 0 rgba(255,255,255,.9); }

    .bubble .aura {
      position: absolute; inset: -10px;
      border-radius: 50%;
      pointer-events: none;
      border: 2px solid rgba(255,255,255,.9);
      box-shadow: 0 0 24px var(--special-glow), inset 0 0 18px var(--special-glow);
      animation: auraPulse 1.4s ease-in-out infinite;
    }
    @keyframes auraPulse { 0%,100% {opacity:.9; transform:scale(1)} 50% {opacity:.55; transform:scale(1.08)} }

    /* Per-type glow colours */
    .special-skip  { --special-glow: rgba(99,102,241,.55); }   /* indigo */
    .special-prune { --special-glow: rgba(236,72,153,.55); }   /* pink */
    .special-slow  { --special-glow: rgba(34,197,94,.55); }    /* green */

    /* Optional: slight screen tint during Time Freeze */
    body.bullet-time::after{
      content:"";
      position: fixed; inset: 0;
      background: radial-gradient(circle at 50% 35%, rgba(255,255,255,.25), rgba(255,255,255,0));
      pointer-events: none;
      animation: btFade 2.2s ease-out forwards;
    }
    @keyframes btFade { from{opacity:1} to{opacity:0} }

    @media (max-width: 768px) {
      .streak-bar {
        top: 80px;
        right: 8px;
        width: 100px;
        height: 5px;
      }
      
      .milestone-text {
        font-size: clamp(24px, 8vw, 36px);
      }
    }

  </style>
</head>
<body>
  <!-- Main Menu -->
  <div class="menu-overlay" id="menuOverlay">
    <div class="menu-panel">
      <h1 class="menu-title">Bubble Math</h1>
      <p class="menu-subtitle">Catch the correct answers before they fall!</p>
      
      <div class="stats-section">
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="bestScoreStat">0</div>
            <div class="stat-label">Best Score</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="bestStreakStat">0</div>
            <div class="stat-label">Best Streak</div>
          </div>
        </div>
      </div>

      <div class="menu-section">
        <h3>Difficulty</h3>
        <div class="menu-buttons">
          <button class="menu-btn active" onclick="setMenuDifficulty('easy')" id="menuEasyBtn">Easy (2-5)</button>
          <button class="menu-btn" onclick="setMenuDifficulty('medium')" id="menuMediumBtn">Medium (2-8)</button>
          <button class="menu-btn" onclick="setMenuDifficulty('hard')" id="menuHardBtn">Hard (2-12)</button>
        </div>
      </div>

      <div class="menu-section">
        <h3>Speed</h3>
        <div class="menu-buttons">
          <button class="menu-btn" onclick="setMenuSpeed('slow')" id="menuSlowBtn">Slow</button>
          <button class="menu-btn active" onclick="setMenuSpeed('normal')" id="menuNormalBtn">Normal</button>
          <button class="menu-btn" onclick="setMenuSpeed('fast')" id="menuFastBtn">Fast</button>
          <button class="menu-btn" onclick="setMenuSpeed('crazy')" id="menuCrazyBtn">Crazy</button>
        </div>
      </div>

      <button class="start-btn" onclick="startGame()">🚀 Start Game</button>
    </div>
  </div>

  <!-- Game UI -->
  <div class="hud" id="hud">
    <div class="question" id="question">Ready?</div>
    <div class="score-primary" id="scorePrimary">Score: 0 • Round: 0</div>
    <div class="score-sub" id="scoreSub">Accuracy: 0% • Best: 0</div>
  </div>

  <div class="game-controls" id="gameControls">
    <button class="control-btn" onclick="pauseGame()" id="pauseBtn">Pause</button>
    <button class="control-btn" onclick="showMenu()">Menu</button>
    <button class="control-btn" onclick="toggleHelp()" aria-controls="helpOverlay" title="Help">?</button>
  </div>

  <div class="streak-indicator" id="streakIndicator">🔥 Streak: 0</div>
  <div class="streak-bar"><div id="streakFill"></div></div>
  <div class="feedback" id="feedback"></div>
  <div class="lives-indicator" id="livesIndicator"></div>

  <div class="stage" id="stage"></div>

  <!-- High score toast -->
  <div class="highscore-toast" id="highScoreToast">New High Score!</div>

  <!-- Help overlay -->
  <div class="help-overlay hidden" id="helpOverlay" onclick="toggleHelp()">
    <div class="help-panel" onclick="event.stopPropagation()">
      <h3>How to Play</h3>
      <p>Select the correct answer bubble before it falls.</p>
      <ul>
        <li>Keys 1–<span id="helpKeysMax">6</span>: pop bubbles left→right</li>
        <li>Space: pop the correct answer</li>
        <li>P: pause/resume • Esc: menu</li>
      </ul>
      <button class="menu-btn" onclick="toggleHelp()">Close</button>
    </div>
  </div>

<script>
// --- Game settings ---
const difficulties = {
  easy: { min: 2, max: 5, name: 'Easy' },
  medium: { min: 2, max: 8, name: 'Medium' },
  hard: { min: 2, max: 12, name: 'Hard' }
};

const speeds = {
  slow:   { duration: 12000, name: 'Slow' },
  normal: { duration: 9000,  name: 'Normal' },
  fast:   { duration: 6500,  name: 'Fast'  },
  crazy:  { duration: 4200,  name: 'Crazy' }
};

// Dynamic choices by viewport (fewer on narrow screens)
function getChoicesCount() {
  if (window.matchMedia('(max-width: 360px)').matches) return 4;
  if (window.matchMedia('(max-width: 420px)').matches) return 5;
  return 6;
}
const SPAWN_DELAY = 800;
const STREAK_THRESHOLD = 3;
const MAX_LIVES = 3;

// Specials (same behavior as your current implementation)
const SPECIAL_CHANCE = 0.25;  // Reset to normal 25% chance
const PRUNE_COUNT    = 2;     // pop 2 wrong choices
const FREEZE_MS      = 2200;  // time freeze length

// --- DOM Elements ---
const stage = document.getElementById('stage');
const qEl = document.getElementById('question');
const scorePrimaryEl = document.getElementById('scorePrimary');
const scoreSubEl = document.getElementById('scoreSub');
const streakEl = document.getElementById('streakIndicator');
const feedbackEl = document.getElementById('feedback');
const livesEl = document.getElementById('livesIndicator');
const menuOverlay = document.getElementById('menuOverlay');
const hud = document.getElementById('hud');
const gameControls = document.getElementById('gameControls');

// --- State ---
let score = 0;
let rounds = 0;
let correct = 0;
let streak = 0;
let lives = MAX_LIVES;
let bestStreak = parseInt(localStorage.getItem('bestStreak') || '0');
let highScore = parseInt(localStorage.getItem('highScore') || '0');
let acceptingInput = true;
let currentAnswer = null;
let currentDifficulty = localStorage.getItem('difficulty') || 'easy';
let currentSpeed = localStorage.getItem('speed') || 'normal';
let gameActive = false;
let gamePaused = false;
let spawnTimeouts = [];
let nextQuestionData = null;
let questionHue = 200;

// --- Utils ---
const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const randFloat = (min, max) => Math.random() * (max - min) + min;

function getRandomX(bubbleSize) {
  const stageWidth = window.innerWidth <= 768 ? Math.min(380, window.innerWidth - 40) : 400;
  return randInt(0, Math.max(0, stageWidth - bubbleSize));
}

// Weighted pick for specials
function weightedPick(items) {
  const total = items.reduce((s, i) => s + i.w, 0);
  let r = Math.random() * total;
  for (const i of items) { if ((r -= i.w) <= 0) return i.t; }
  return items[0].t;
}

// --- Visual Effects Utils ---
function getBubbleCenter(element) {
  const b = element.getBoundingClientRect();
  const s = stage.getBoundingClientRect();
  return { x: b.left - s.left + b.width/2, y: b.top - s.top + b.height/2, w: b.width };
}

function createClickWave(x, y) {
  const wave = document.createElement('div');
  wave.className = 'click-wave';
  wave.style.left = `${x}px`;
  wave.style.top = `${y}px`;
  stage.appendChild(wave);
  setTimeout(() => wave.remove(), 300);
}

function makeRipple(x, y) { 
  const ring = document.createElement('div'); 
  ring.className='ring'; 
  ring.style.left=x+'px'; 
  ring.style.top=y+'px'; 
  stage.appendChild(ring); 
  setTimeout(()=>ring.remove(),320); 
}

function makeParticles(x, y, baseSize, isStreak = false) {
  if (isStreak && streak >= 3) { makeExplosion(x, y, baseSize); return; }
  const count = randInt(8, 12);
  for (let i = 0; i < count; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.left = x + 'px';
    p.style.top = y + 'px';
    const angle = randFloat(0, Math.PI * 2);
    const dist = randFloat(baseSize * 0.3, baseSize * 0.8);
    const dx = Math.cos(angle) * dist;
    const dy = Math.sin(angle) * dist;
    p.style.setProperty('--dx', dx.toFixed(1) + 'px');
    p.style.setProperty('--dy', dy.toFixed(1) + 'px');
    const hue = randInt(180, 220);
    const sat = randInt(60, 85);
    p.style.background = `radial-gradient(circle at 30% 30%, hsla(${hue},100%,98%,0.95), hsla(${hue}, ${sat}%, 70%, 0.9))`;
    stage.appendChild(p);
    setTimeout(() => p.remove(), 420);
  }
}

function makeExplosion(x, y, baseSize) {
  document.body.classList.add('screen-shake');
  setTimeout(() => document.body.classList.remove('screen-shake'), 400);
  const shockwave = document.createElement('div'); 
  shockwave.className='shockwave'; 
  shockwave.style.left = x+'px'; 
  shockwave.style.top = y+'px'; 
  stage.appendChild(shockwave); 
  setTimeout(() => shockwave.remove(), 600);
  const fireCount = randInt(15, 20);
  for (let i = 0; i < fireCount; i++) {
    const p = document.createElement('div'); 
    p.className='explosion-particle fire'; 
    p.style.left = x+'px'; 
    p.style.top = y+'px';
    const angle = randFloat(0, Math.PI * 2); 
    const dist = randFloat(baseSize * 0.8, baseSize * 1.5);
    const dx = Math.cos(angle) * dist; 
    const dy = Math.sin(angle) * dist;
    p.style.setProperty('--dx', dx.toFixed(1) + 'px'); 
    p.style.setProperty('--dy', dy.toFixed(1) + 'px');
    stage.appendChild(p); 
    setTimeout(() => p.remove(), 800);
  }
  const sparkCount = randInt(12, 18);
  for (let i = 0; i < sparkCount; i++) {
    const p = document.createElement('div'); 
    p.className='explosion-particle spark'; 
    p.style.left = x+'px'; 
    p.style.top = y+'px';
    const angle = randFloat(0, Math.PI * 2); 
    const dist = randFloat(baseSize * 1.2, baseSize * 2);
    const dx = Math.cos(angle) * dist; 
    const dy = Math.sin(angle) * dist;
    p.style.setProperty('--dx', dx.toFixed(1) + 'px'); 
    p.style.setProperty('--dy', dy.toFixed(1) + 'px');
    stage.appendChild(p); 
    setTimeout(() => p.remove(), 900);
  }
  const smokeCount = randInt(6, 10);
  for (let i = 0; i < smokeCount; i++) {
    const p = document.createElement('div'); 
    p.className='explosion-particle smoke'; 
    p.style.left = x+'px'; 
    p.style.top = y+'px';
    const angle = randFloat(0, Math.PI * 2); 
    const dist = randFloat(baseSize * 0.4, baseSize * 1);
    const dx = Math.cos(angle) * dist; 
    const dy = Math.sin(angle) * dist;
    p.style.setProperty('--dx', dx.toFixed(1) + 'px'); 
    p.style.setProperty('--dy', dy.toFixed(1) + 'px');
    stage.appendChild(p); 
    setTimeout(() => p.remove(), 1200);
  }
}

function stageFlash(){ 
  const f = document.createElement('div'); 
  f.className='flash'; 
  stage.appendChild(f); 
  setTimeout(()=>f.remove(),240); 
}

function showFeedback(text, isCorrect){ 
  feedbackEl.textContent = text; 
  feedbackEl.style.color = isCorrect ? 'var(--correct)' : 'var(--wrong)'; 
  feedbackEl.classList.add('show'); 
  setTimeout(()=>feedbackEl.classList.remove('show'), 600); 
}

function showAnswerReveal(answer) {
  const reveal = document.createElement('div'); 
  reveal.className = 'answer-reveal'; 
  reveal.textContent = `Answer: ${answer}`;
  reveal.style.left = '50%'; 
  reveal.style.top = '40%'; 
  reveal.style.transform = 'translateX(-50%)';
  stage.appendChild(reveal); 
  setTimeout(() => reveal.remove(), 1500);
}

function celebrateMilestone(count) {
  const celebration = document.createElement('div'); 
  celebration.className = `milestone-celebration milestone-${count}`;
  const text = document.createElement('div'); 
  text.className = 'milestone-text';
  if (count === 7) text.textContent = '7 in a row!\nAmazing!';
  else if (count === 10) text.textContent = '10 in a row!\nIncredible!';
  else if (count === 15) text.textContent = '15 in a row!\nUnstoppable!';
  celebration.appendChild(text);
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div'); 
    confetti.className='confetti';
    confetti.style.left = `${randInt(0, 100)}%`; 
    confetti.style.top = '-10px';
    confetti.style.setProperty('--confetti-color', `hsl(${randInt(0, 360)}, 100%, 50%)`);
    confetti.style.animationDuration = `${randFloat(1, 3)}s`; 
    confetti.style.animationDelay = `${randFloat(0, 0.5)}s`;
    celebration.appendChild(confetti);
  }
  for (let i = 0; i < 10; i++) {
    setTimeout(() => {
      const startX = randInt(20, 80), startY = randInt(20, 80);
      for (let j = 0; j < 20; j++) {
        const firework = document.createElement('div'); 
        firework.className='firework';
        firework.style.left = `${startX}%`; 
        firework.style.top = `${startY}%`;
        firework.style.backgroundColor = `hsl(${randInt(0, 360)}, 100%, 60%)`;
        const angle = randFloat(0, Math.PI * 2); 
        const distance = randFloat(30, 100);
        firework.style.setProperty('--startX','0px'); 
        firework.style.setProperty('--startY','0px');
        firework.style.setProperty('--endX', `${Math.cos(angle)*distance}px`);
        firework.style.setProperty('--endY', `${Math.sin(angle)*distance}px`);
        celebration.appendChild(firework);
      }
    }, i * 100);
  }
  document.body.appendChild(celebration); 
  setTimeout(() => celebration.remove(), 2500);
}

// ---------- Lives ----------
function updateLives() {
  livesEl.innerHTML = '';
  for (let i = 0; i < MAX_LIVES; i++) {
    const heart = document.createElement('div');
    heart.className = i >= lives ? 'heart lost' : 'heart';
    livesEl.appendChild(heart);
  }
}

function loseLife() {
  lives--;
  updateLives();
  if (lives <= 0) gameOver();
}

// ---------- BUBBLE OOP LAYER ----------
class BubbleRegistry {
  static items = new Set();
  static add(b) { this.items.add(b); }
  static remove(b) { this.items.delete(b); }
  static forQuestion(qId) { return [...this.items].filter(b => b.questionId === qId); }
  static answersOnly(qId) { return this.forQuestion(qId).filter(b => !b.isSpecial); }
  static expireOld(currentRound) { this.items.forEach(b => { if (b.questionId < currentRound) b.expire(); }); }
  static pauseAll() { this.items.forEach(b => b.setPaused(true)); }
  static resumeAll() { this.items.forEach(b => b.setPaused(false)); }
  static destroyAll() { this.items.forEach(b => b.destroy()); this.items.clear(); }
}

class Bubble {
  constructor({ value, isAnswer=false, isPowerUp=false, questionId, paletteFilter='', fallMs=null, size=null, labelOverride=null, classes=[] }) {
    this.value = value;
    this.isAnswer = isAnswer;
    this.isPowerUp = isPowerUp;
    this.questionId = questionId;
    this.isSpecial = false;

    this.size = size ?? randInt(60, 80);
    this.fallMs = fallMs ?? this.calculateFallDuration();
    this.paletteFilter = paletteFilter;

    this.el = this.buildElement(labelOverride, classes);
    this.missTimer = null;

    BubbleRegistry.add(this);
    this.armMissTimer();
  }

  calculateFallDuration() {
    const base = speeds[currentSpeed].duration;
    const jitter = randInt(-200, 700);
    return Math.max(2500, base + jitter);
  }

  buildElement(labelOverride, classes) {
    const el = document.createElement('div');
    el.className = `bubble falling ${classes.join(' ')}`.trim();
    el.dataset.value = String(this.value);
    el.dataset.answer = this.isAnswer ? '1' : '0';
    el.dataset.powerUp = this.isPowerUp ? '1' : '0';
    el.dataset.questionId = this.questionId;

    el.style.width = el.style.height = `${this.size}px`;
    el.style.left = `${getRandomX(this.size)}px`;
    el.style.top = '-150px';
    el.style.willChange = 'transform, opacity';
    el.style.transform = 'translate3d(0,0,0)';
    el.style.setProperty('--fallMs', `${this.fallMs}ms`);
    if (!this.isPowerUp) el.style.filter = this.paletteFilter;

    const label = document.createElement('div');
    label.className = 'label';
    if (String(this.value).includes('6') || String(this.value).includes('9')) label.classList.add('underlined');
    label.textContent = labelOverride ?? this.value;
    el.appendChild(label);

    // Support both pointer and programmatic .click()
    el.addEventListener('pointerdown', (e)=>{ e.preventDefault(); this.handleClick(); });
    el.addEventListener('click', ()=> this.handleClick());

    stage.appendChild(el);
    return el;
  }

  setPaused(paused) { 
    this.el.style.animationPlayState = paused ? 'paused' : 'running'; 
  }

  expire() { 
    this.el.classList.add('expired'); 
  }

  clearMissTimer() { 
    if (this.missTimer) { 
      clearTimeout(this.missTimer); 
      this.missTimer = null; 
    } 
  }

  armMissTimer() {
    this.clearMissTimer();
    this.missTimer = setTimeout(() => {
      if (!this.el.parentNode || !gameActive || gamePaused) return;
      if (this.questionId === rounds && this.isAnswer) {
        loseLife();
        streak = 0;
        rounds++;
        updateScore();
        showFeedback('Missed!', false);
        showAnswerReveal(currentAnswer);
        stageFlash();
        const ghost = document.createElement('div');
        ghost.className = 'ghost';
        ghost.style.left = this.el.style.left;
        ghost.style.top = (window.innerHeight - 90) + 'px';
        stage.appendChild(ghost);
        setTimeout(() => ghost.remove(), 1000);
        setTimeout(() => { if (gameActive) generateQuestion(); }, 300);
      }
      this.destroy();
    }, this.fallMs + 120);
  }

  handleClick() {
    if (!acceptingInput || !gameActive || gamePaused) return;
    const { x, y, w } = getBubbleCenter(this.el);
    if (navigator.vibrate) navigator.vibrate(this.isAnswer ? 20 : [60, 30, 30]);

    this.el.classList.remove('falling'); 
    void this.el.offsetWidth;

    if (this.isAnswer) {
      acceptingInput = false;
      this.el.classList.add('correct');

      const points = this.isPowerUp ? 3 : 1;
      score += points; 
      correct++; 
      streak++; 
      rounds++;
      
      if (streak === 7 || streak === 10 || streak === 15) celebrateMilestone(streak);
      if (streak > bestStreak) { 
        bestStreak = streak; 
        localStorage.setItem('bestStreak', bestStreak); 
      }
      updateScore();

      requestAnimationFrame(() => {
        createClickWave(x, y);
        makeRipple(x, y);
        makeParticles(x, y, w, streak >= STREAK_THRESHOLD);
        stageFlash();
        showFeedback(this.isPowerUp ? `Power Up! +${points} points!` :
                      (streak >= STREAK_THRESHOLD ? `${streak} streak!` : 'Correct!'), true);
      });

      this.el.addEventListener('animationend', () => this.destroy(), { once: true });
      setTimeout(() => { if (gameActive) { acceptingInput = true; generateQuestion(); } }, 320);

    } else {
      streak = 0; 
      loseLife(); 
      updateScore();
      this.el.classList.add('wrong');
      requestAnimationFrame(() => { 
        stageFlash(); 
        showFeedback('Wrong!', false); 
      });
      this.el.addEventListener('animationend', () => this.destroy(), { once: true });
    }
  }

  destroy() {
    this.clearMissTimer();
    if (this.el && this.el.parentNode) this.el.remove();
    BubbleRegistry.remove(this);
  }
}

class SpecialBubble extends Bubble {
  constructor({ type, questionId, fallMs }) {
    const size = randInt(54, 68);
    const labelMap = { skip: '⏭', prune: '➖', slow: '🕓' };
    
    // Calculate fall duration here if not provided
    const calculatedFallMs = fallMs ?? (() => {
      const base = speeds[currentSpeed].duration;
      return Math.max(1200, Math.floor(base * 0.55) + randInt(-200, 150));
    })();
    
    super({
      value: null,
      isAnswer: false,
      isPowerUp: false,
      questionId,
      paletteFilter: '',
      fallMs: calculatedFallMs,
      size,
      labelOverride: labelMap[type] || '★',
      classes: ['special', `special-${type}`]
    });
    this.type = type;
    this.isSpecial = true;

    const aura = document.createElement('div'); 
    aura.className = 'aura'; 
    this.el.appendChild(aura);
  }

  handleClick() {
    if (!gameActive || gamePaused) return;
    const { x, y, w } = getBubbleCenter(this.el);
    this.el.classList.remove('falling'); 
    void this.el.offsetWidth;
    this.el.classList.add('correct');
    this.el.addEventListener('animationend', () => this.destroy(), { once: true });

    makeRipple(x, y); 
    makeParticles(x, y, w, true); 
    stageFlash();

    if (this.type === 'skip') {
      showFeedback('⏭ Skipped!', true); 
      performSkip();
    } else if (this.type === 'prune') {
      showFeedback(`➖ Removed ${PRUNE_COUNT}`, true); 
      performPrune(PRUNE_COUNT);
    } else if (this.type === 'slow') {
      showFeedback('🕓 Time Freeze!', true); 
      bulletTime(FREEZE_MS);
    }
  }
}

// ---------- Menu / prefs ----------
function updateMenuStats() {
  document.getElementById('bestScoreStat').textContent = highScore;
  document.getElementById('bestStreakStat').textContent = bestStreak;
}

function setMenuDifficulty(level) {
  currentDifficulty = level;
  ['menuEasyBtn','menuMediumBtn','menuHardBtn'].forEach(id => {
    const el = document.getElementById(id); 
    if (el) el.classList.remove('active');
  });
  const btnId = 'menu' + level.charAt(0).toUpperCase() + level.slice(1) + 'Btn';
  const el = document.getElementById(btnId); 
  if (el) el.classList.add('active');
  localStorage.setItem('difficulty', currentDifficulty);
}

function setMenuSpeed(speed) {
  currentSpeed = speed;
  ['menuSlowBtn','menuNormalBtn','menuFastBtn','menuCrazyBtn'].forEach(id => {
    const el = document.getElementById(id); 
    if (el) el.classList.remove('active');
  });
  const btnId = 'menu' + speed.charAt(0).toUpperCase() + speed.slice(1) + 'Btn';
  const el = document.getElementById(btnId); 
  if (el) el.classList.add('active');
  localStorage.setItem('speed', currentSpeed);
}

function initPreferences() {
  setMenuDifficulty(currentDifficulty);
  setMenuSpeed(currentSpeed);
  const keysMax = document.getElementById('helpKeysMax');
  if (keysMax) keysMax.textContent = String(getChoicesCount());
}

function showMenu() {
  gameActive = false;
  gamePaused = true;
  const card = document.querySelector('.recap-card');
  if (card) card.remove();

  spawnTimeouts.forEach(timeout => clearTimeout(timeout));
  spawnTimeouts = [];

  // Kill all bubbles via registry
  BubbleRegistry.destroyAll();

  hud.classList.remove('visible');
  gameControls.classList.remove('visible');
  livesEl.classList.remove('visible');

  menuOverlay.classList.remove('hidden');
  updateMenuStats();
}

function startGame() {
  menuOverlay.classList.add('hidden');

  setTimeout(() => {
    hud.classList.add('visible');
    gameControls.classList.add('visible');
    livesEl.classList.add('visible');
  }, 300);

  resetGame();

  gameActive = true;
  gamePaused = false;

  preloadNextQuestion();
  generateQuestion();
}

function pauseGame() {
  if (!gameActive) return;
  gamePaused = !gamePaused;
  const pauseBtn = document.getElementById('pauseBtn');
  if (gamePaused) {
    pauseBtn.textContent = 'Resume';
    BubbleRegistry.pauseAll();
  } else {
    pauseBtn.textContent = 'Pause';
    BubbleRegistry.resumeAll();
  }
}

// ---------- Specials: spawn + actions ----------
function maybeSpawnSpecial(choiceCount, currentQuestionId) {
  if (Math.random() > SPECIAL_CHANCE) return;
  const type = weightedPick([
    { t: 'skip',  w: 0.4 },
    { t: 'prune', w: 0.35 },
    { t: 'slow',  w: 0.25 },
  ]);
  const jitterDelay = randInt(0, SPAWN_DELAY * Math.max(1, choiceCount - 1));
  spawnSpecial(type, jitterDelay, currentQuestionId);
}

function spawnSpecial(type, delay = 0, questionId) {
  const timeout = setTimeout(() => {
    if (!gameActive || gamePaused) return;
    new SpecialBubble({ type, questionId });
  }, delay);
  spawnTimeouts.push(timeout);
}

function performSkip() {
  // Pop all current-question answer bubbles (keep it visually satisfying)
  const current = BubbleRegistry.answersOnly(rounds);
  current.forEach(b => b.el.classList.contains('expired') ? b.destroy()
                                                         : b.el.classList.add('correct') || b.el.addEventListener('animationend', () => b.destroy(), { once: true }));
  rounds++;
  updateScore();
  preloadNextQuestion();
  setTimeout(() => gameActive && generateQuestion(), 240);
}

function performPrune(n = 2) {
  const wrongs = BubbleRegistry.answersOnly(rounds)
    .filter(b => !b.isAnswer && !b.el.classList.contains('expired'));
  for (let i = 0; i < n && wrongs.length; i++) {
    const idx = randInt(0, wrongs.length - 1);
    const b = wrongs.splice(idx, 1)[0];
    b.el.classList.remove('falling'); 
    void b.el.offsetWidth;
    b.el.classList.add('correct');
    b.el.addEventListener('animationend', () => b.destroy(), { once: true });
  }
}

function bulletTime(ms = FREEZE_MS) {
  document.body.classList.add('bullet-time');
  BubbleRegistry.pauseAll();
  setTimeout(() => {
    BubbleRegistry.resumeAll();
    document.body.classList.remove('bullet-time');
  }, ms);
}

// ---------- Question lifecycle ----------
function preloadNextQuestion() {
  const diff = difficulties[currentDifficulty];
  const a = randInt(diff.min, diff.max);
  const b = randInt(diff.min, diff.max);
  const product = a * b;

  const set = new Set([product]);
  const choiceCount = getChoicesCount();

  const neighbours = [
    a * (b - 1), a * (b + 1),
    (a - 1) * b, (a + 1) * b,
    product - a, product + a,
    product - b, product + b,
  ].filter(n => Number.isFinite(n) && n > 0);

  for (const n of neighbours) if (set.size < choiceCount) set.add(n);

  while (set.size < choiceCount) {
    const x = randInt(diff.min, diff.max);
    const y = randInt(diff.min, diff.max);
    if (x * y !== product) set.add(x * y);
  }

  const choices = Array.from(set).sort(() => Math.random() - 0.5);
  const shouldAddPowerUp = streak >= 3 && Math.random() < 0.15;

  nextQuestionData = { a, b, product, choices, shouldAddPowerUp };
}

function generateQuestion() {
  if (!gameActive || gamePaused) return;
  if (!nextQuestionData) preloadNextQuestion();

  const { a, b, product, choices, shouldAddPowerUp } = nextQuestionData;
  currentAnswer = product;

  qEl.textContent = `${a} × ${b} = ?`;
  questionHue = (questionHue + 40) % 360;
  document.documentElement.style.setProperty('--question-hue', `${questionHue}deg`);

  // Visually expire older bubbles via registry
  BubbleRegistry.expireOld(rounds);

  const palette = [
    'hue-rotate(0deg) saturate(1.1)',
    'hue-rotate(60deg) saturate(1.2)',
    'hue-rotate(160deg) saturate(1.1)',
    'hue-rotate(220deg) saturate(1.3)',
    'hue-rotate(280deg) saturate(1.2)'
  ];

  // Spawn answer/wrong set - directly instantiate bubbles
  choices.forEach((val, idx) => {
    const isAnswer = val === product;
    const isPowerUp = shouldAddPowerUp && isAnswer;
    const delay = idx * SPAWN_DELAY;
    
    const timeout = setTimeout(() => {
      if (!gameActive || gamePaused) return;
      new Bubble({ 
        value: val, 
        isAnswer, 
        isPowerUp, 
        questionId: rounds, 
        paletteFilter: palette[rounds % palette.length] 
      });
    }, delay);
    spawnTimeouts.push(timeout);
  });

  // Occasionally drop a special
  maybeSpawnSpecial(choices.length, rounds);

  preloadNextQuestion();
}

// ---------- Score / game over ----------
function updateScore() {
  const hue = 160 + Math.min(140, score / 3);
  document.body.style.setProperty('--hue', hue);
  const acc = rounds ? Math.round((correct / rounds) * 100) : 0;
  if (scorePrimaryEl) scorePrimaryEl.textContent = `Score: ${score} • Round: ${rounds}`;
  if (scoreSubEl) scoreSubEl.textContent = `Accuracy: ${acc}% • Best: ${highScore}`;

  const percent = Math.min(100, (streak / 3) * 100);
  const bar = document.getElementById('streakFill');
  bar.style.width = percent + '%';
  document.querySelector('.streak-bar').classList.toggle('show', streak > 0);

  if (score > highScore) {
    highScore = score;
    localStorage.setItem('highScore', highScore.toString());
    const toast = document.getElementById('highScoreToast');
    if (toast) { toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 1200); }
  }

  if (streak >= STREAK_THRESHOLD) {
    streakEl.textContent = `🔥 Streak: ${streak} (Best: ${bestStreak})`;
    streakEl.classList.add('show');
  } else {
    streakEl.classList.remove('show');
  }
}

function gameOver() {
  gameActive = false;
  acceptingInput = false;

  spawnTimeouts.forEach(t => clearTimeout(t));
  spawnTimeouts = [];
  BubbleRegistry.destroyAll();

  // Recap card
  const card = document.createElement('div');
  card.className = 'recap-card';
  card.innerHTML = `
    <h2>Great job!</h2>
    <p>Score <b>${score}</b></p>
    <p>Best streak <b>${streak}</b></p>
    <p>Accuracy <b>${Math.round((correct/rounds)*100)||0}%</b></p>
    <button onclick="showMenu()">Menu</button>
  `;
  document.body.appendChild(card);
  requestAnimationFrame(() => card.classList.add('show'));
  setTimeout(() => { const c = document.querySelector('.recap-card'); if (c) c.remove(); }, 4000);
}

function resetGame() {
  spawnTimeouts.forEach(timeout => clearTimeout(timeout));
  spawnTimeouts = [];

  score = 0; rounds = 0; correct = 0; streak = 0; lives = MAX_LIVES;
  acceptingInput = true; gamePaused = false;
  nextQuestionData = null; questionHue = 200;

  BubbleRegistry.destroyAll();

  updateScore();
  updateLives();

  qEl.textContent = 'Ready?';
  document.getElementById('pauseBtn').textContent = 'Pause';
}

// ---------- Keyboard controls ----------
document.addEventListener('keydown', (e) => {
  if (!gameActive || gamePaused) return;

  const maxKey = getChoicesCount();
  if (e.key >= '1' && e.key <= String(maxKey)) {
    // Left→right among *answer/wrong* bubbles for current question (exclude specials)
    const arr = BubbleRegistry.answersOnly(rounds)
      .filter(b => !b.el.classList.contains('expired'));
    arr.sort((a, b) => parseFloat(a.el.style.left) - parseFloat(b.el.style.left));

    const index = parseInt(e.key, 10) - 1;
    const target = arr[index];
    if (target) target.handleClick();
  } else if (e.key === ' ') {
    e.preventDefault();
    const target = BubbleRegistry.answersOnly(rounds).find(b => b.isAnswer);
    if (target) target.handleClick();
  } else if (e.key === 'p' || e.key === 'P') {
    pauseGame();
  } else if (e.key === 'Escape') {
    showMenu();
  }
});

// Prevent context menu on touch devices
document.addEventListener('contextmenu', (e) => e.preventDefault());

// Resize safety (keep your behavior)
window.addEventListener('resize', () => {
  const sw = stage.clientWidth;
  document.querySelectorAll('.bubble').forEach(b => {
    const w = b.offsetWidth;
    const currentX = parseFloat(b.style.left) || 0;
    const newX = Math.min(currentX, Math.max(0, sw - w));
    b.style.left = newX + 'px';
  });
});

function toggleHelp() {
  const el = document.getElementById('helpOverlay');
  el.classList.toggle('hidden');
  const keysMax = document.getElementById('helpKeysMax');
  if (keysMax) keysMax.textContent = String(getChoicesCount());
}

// ---------- Initialize ----------
initPreferences();
updateMenuStats();
resetGame();
</script>

</body>
</html>
