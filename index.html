<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reconstitution Dose–Volume Calculator</title>
<style>
  :root { --bg:#0f1522; --card:#141c2e; --ink:#eef3ff; --muted:#9fb0d1; --accent:#5dd6b9; --focus:#2a7be4; --danger:#ff9c9c; }
  * { box-sizing: border-box; }
  body { margin:0; background:var(--bg); color:var(--ink); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans"; padding:24px; }
  .app { max-width:860px; margin:auto; }
  .card { background:var(--card); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  h1 { margin:0 0 12px; font-weight:700; letter-spacing:.2px; }
  p.hint { margin:.25rem 0 1rem; color:var(--muted); }
  .grid { display:grid; gap:12px; grid-template-columns: repeat(12, 1fr); }
  .row { grid-column: 1 / -1; display:flex; gap:10px; align-items:center; }
  label { font-size:.9rem; color:var(--muted); display:block; margin-bottom:6px; }
  input, select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3856; background:#0e1524; color:var(--ink); outline:none; }
  input:focus, select:focus { border-color:var(--focus); box-shadow:0 0 0 3px rgba(42,123,228,.25); }
  .col-6 { grid-column: span 6; }
  .col-4 { grid-column: span 4; }
  .col-3 { grid-column: span 3; }
  .col-2 { grid-column: span 2; }
  .mode { display:flex; gap:10px; margin:8px 0 16px; }
  .mode button { flex:1; padding:10px 12px; border-radius:12px; border:1px solid #2a3856; background:#0e1524; color:var(--ink); cursor:pointer; }
  .mode button.active { border-color:var(--accent); box-shadow:0 0 0 3px rgba(93,214,185,.25) inset; }
  .actions { display:flex; gap:10px; margin-top:10px; }
  .btn { padding:12px 16px; border-radius:12px; border:none; cursor:pointer; font-weight:600; }
  .btn.primary { background:var(--accent); color:#061017; }
  .btn.ghost { background:transparent; border:1px solid #2a3856; color:var(--ink); }
  .result { margin-top:16px; padding:14px; border-radius:12px; background:#0e172a; border:1px dashed #2a3856; }
  .result b { color:var(--accent); }
  .warn { color:var(--danger); font-size:.9rem; }
  small.code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:#b8c7ea; }
  .examples { margin-top:6px; color:var(--muted); }
</style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Reconstitution Dose–Volume Calculator</h1>
      <p class="hint">Compute the mL to draw up. Formula: <small class="code">Volume (mL) = Ordered dose (mg) ÷ Final concentration (mg/mL)</small></p>

      <div class="mode" id="modeTabs">
        <button data-mode="conc" class="active">I know the final concentration</button>
        <button data-mode="derive">I know vial amount &amp; final volume</button>
      </div>

      <!-- Ordered dose -->
      <div class="grid">
        <div class="col-6">
          <label for="doseVal">Ordered dose</label>
          <input id="doseVal" type="number" min="0" step="0.01" placeholder="e.g., 200">
        </div>
        <div class="col-3">
          <label for="doseUnit">Dose unit</label>
          <select id="doseUnit">
            <option value="mg">mg</option>
            <option value="g">g</option>
          </select>
        </div>
      </div>

      <!-- Mode A: direct concentration -->
      <div id="modeConc">
        <div class="grid" style="margin-top:10px;">
          <div class="col-6">
            <label for="concVal">Final concentration</label>
            <input id="concVal" type="number" min="0" step="0.0001" placeholder="e.g., 62.5">
          </div>
          <div class="col-3">
            <label for="concUnit">Units</label>
            <select id="concUnit">
              <option value="mg/mL">mg/mL</option>
              <option value="g/mL">g/mL</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Mode B: derive concentration from vial + volume -->
      <div id="modeDerive" style="display:none;">
        <div class="grid" style="margin-top:10px;">
          <div class="col-4">
            <label for="vialVal">Vial amount</label>
            <input id="vialVal" type="number" min="0" step="0.01" placeholder="e.g., 500">
          </div>
          <div class="col-2">
            <label for="vialUnit">Unit</label>
            <select id="vialUnit">
              <option value="mg">mg</option>
              <option value="g">g</option>
            </select>
          </div>
          <div class="col-4">
            <label for="finalVol">Final volume after reconstitution (mL)</label>
            <input id="finalVol" type="number" min="0" step="0.01" placeholder="e.g., 8">
          </div>
        </div>
        <p class="hint">This mode assumes the label’s “reconstituted to a total of X mL” style instruction.</p>
      </div>

      <!-- Quick examples -->
      <div class="examples">
        <label for="examplesSelect">Examples (auto-fill):</label>
        <select id="examplesSelect">
          <option value="">— pick one —</option>
          <option value="solu200">Solu-Medrol 200 mg; 500 mg → 8 mL</option>
          <option value="zithro400">Zithromax 400 mg; 100 mg/mL</option>
          <option value="ticar31">Ticarcillin 3.1 g; 0.155 g/mL</option>
          <option value="kefzol500">Cefazolin 500 mg; 1 g → 4 mL (250 mg/mL)</option>
          <option value="claforan1g">Claforan 1 g IM; 300 mg/mL</option>
        </select>
      </div>

      <div class="actions">
        <button class="btn primary" id="calcBtn">Calculate</button>
        <button class="btn ghost" id="resetBtn">Reset</button>
      </div>

      <div class="result" id="resultBox" hidden>
        <div id="resultText"></div>
        <div id="warnText" class="warn"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   OO Core
   ========================= */
class Units {
  static mgFrom(value, unit) {
    if (value == null || isNaN(value)) return NaN;
    return unit === 'g' ? value * 1000 : value;
  }
  static concMgPerMl(value, unit) {
    if (value == null || isNaN(value)) return NaN;
    return unit === 'g/mL' ? value * 1000 : value; // g/mL → mg/mL
  }
  static roundTenth(x) {
    return Math.round(x * 10) / 10;
  }
}

class DoseOrder {
  constructor(amount, unit = 'mg') {
    this.mg = Units.mgFrom(Number(amount), unit);
  }
}

class Reconstitution {
  // Mode A: final concentration known
  static fromConcentration(value, unit = 'mg/mL') {
    const mgPerMl = Units.concMgPerMl(Number(value), unit);
    return new Reconstitution(mgPerMl);
  }
  // Mode B: vial amount + final volume known
  static fromVialAndVolume(vialAmount, vialUnit, finalMl) {
    const mg = Units.mgFrom(Number(vialAmount), vialUnit);
    const ml = Number(finalMl);
    const mgPerMl = mg / ml;
    return new Reconstitution(mgPerMl);
  }
  constructor(mgPerMl) {
    this.mgPerMl = mgPerMl;
  }
}

class DoseVolumeCalculator {
  static volumeToDraw(order, recon) {
    if (!isFinite(order.mg) || !isFinite(recon.mgPerMl) || recon.mgPerMl <= 0) return NaN;
    return order.mg / recon.mgPerMl; // mL
  }
}

/* =========================
   UI Wiring
   ========================= */
const el = id => document.getElementById(id);

const modeTabs = el('modeTabs');
const modeConc = el('modeConc');
const modeDerive = el('modeDerive');
let mode = 'conc';

modeTabs.addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;
  mode = btn.dataset.mode;
  [...modeTabs.querySelectorAll('button')].forEach(b => b.classList.toggle('active', b === btn));
  modeConc.style.display = (mode === 'conc') ? '' : 'none';
  modeDerive.style.display = (mode === 'derive') ? '' : 'none';
});

el('calcBtn').addEventListener('click', () => {
  // Dose
  const dose = new DoseOrder(el('doseVal').value, el('doseUnit').value);

  // Build reconstitution object based on mode
  let recon;
  if (mode === 'conc') {
    recon = Reconstitution.fromConcentration(el('concVal').value, el('concUnit').value);
  } else {
    recon = Reconstitution.fromVialAndVolume(el('vialVal').value, el('vialUnit').value, el('finalVol').value);
  }

  const raw = DoseVolumeCalculator.volumeToDraw(dose, recon);
  const out = Units.roundTenth(raw);

  const res = el('resultBox');
  const txt = el('resultText');
  const warn = el('warnText');
  res.hidden = false;

  if (!isFinite(out)) {
    txt.innerHTML = `Please check your entries—something’s off.`;
    warn.textContent = '';
    return;
  }

  // Light sanity notes
  const flags = [];
  if (out <= 0) flags.push('Volume is zero or negative.');
  if (out > 10) flags.push('Large draw; ensure this matches clinical guidance and max IM site volumes.');
  if (recon.mgPerMl > 500) flags.push('Very concentrated; verify label math.');

  const modeLine = (mode === 'conc')
    ? `<small class="code">Conc = ${Number(el('concVal').value)} ${el('concUnit').value}</small>`
    : `<small class="code">Conc = (vial ÷ volume) = ${Number(el('vialVal').value)} ${el('vialUnit').value} ÷ ${Number(el('finalVol').value)} mL</small>`;

  txt.innerHTML = `
    <div style="font-size:1.1rem;">
      Draw up: <b>${out.toFixed(1)} mL</b>
    </div>
    <div style="margin-top:6px;">
      <small class="code">Dose = ${Number(el('doseVal').value)} ${el('doseUnit').value}</small><br/>
      ${modeLine}<br/>
      <small class="code">mL = (dose mg) ÷ (mg/mL)</small>
    </div>
  `;
  warn.textContent = flags.join(' ');
});

el('resetBtn').addEventListener('click', () => {
  document.querySelectorAll('input').forEach(i => i.value = '');
  el('doseUnit').value = 'mg';
  el('concUnit').value = 'mg/mL';
  el('vialUnit').value = 'mg';
  el('resultBox').hidden = true;
  el('examplesSelect').value = '';
});

// Examples autofill
el('examplesSelect').addEventListener('change', (e) => {
  const v = e.target.value;
  // wipe
  el('doseVal').value = '';
  el('concVal').value = '';
  el('vialVal').value = '';
  el('finalVol').value = '';

  const activate = (m) => {
    mode = m;
    [...modeTabs.querySelectorAll('button')].forEach(b => b.classList.toggle('active', b.dataset.mode === m));
    modeConc.style.display = (m === 'conc') ? '' : 'none';
    modeDerive.style.display = (m === 'derive') ? '' : 'none';
  };

  if (v === 'solu200') {
    // 500 mg → 8 mL; order 200 mg → 3.2 mL
    activate('derive');
    el('doseVal').value = 200; el('doseUnit').value = 'mg';
    el('vialVal').value = 500; el('vialUnit').value = 'mg';
    el('finalVol').value = 8;
  }
  if (v === 'zithro400') {
    // 100 mg/mL; order 400 mg → 4.0 mL
    activate('conc');
    el('doseVal').value = 400; el('doseUnit').value = 'mg';
    el('concVal').value = 100; el('concUnit').value = 'mg/mL';
  }
  if (v === 'ticar31') {
    // 0.155 g/mL; order 3.1 g → 20.0 mL
    activate('conc');
    el('doseVal').value = 3.1; el('doseUnit').value = 'g';
    el('concVal').value = 0.155; el('concUnit').value = 'g/mL';
  }
  if (v === 'kefzol500') {
    // 1 g → 4 mL (250 mg/mL); order 500 mg → 2.0 mL
    activate('derive');
    el('doseVal').value = 500; el('doseUnit').value = 'mg';
    el('vialVal').value = 1; el('vialUnit').value = 'g';
    el('finalVol').value = 4;
  }
  if (v === 'claforan1g') {
    // 300 mg/mL; order 1 g → 3.3 mL
    activate('conc');
    el('doseVal').value = 1; el('doseUnit').value = 'g';
    el('concVal').value = 300; el('concUnit').value = 'mg/mL';
  }
});
</script>
</body>
</html>
